{"version":3,"sources":["helpers/cache.ts","helpers/CustomError.ts","apis/BrsUrlProvider.ts","apis/BrsAuth.ts","apis/GoogleAuth.ts","Context.tsx","components/shared/SubmitWithLoading/index.tsx","Constants.ts","components/login/BrsLoginForm/index.tsx","components/login/GoogleLoginButton.tsx","components/shared/CustomAlert.tsx","components/login/LoginPage/index.tsx","components/login/LoginPageContainer.tsx","apis/BrsApi.ts","apis/GoogleApi.ts","helpers/tools.ts","helpers/brsHelpers.ts","managers/SpreadsheetManager.ts","components/shared/NestedList/index.tsx","components/work/RunWorkerButtons.tsx","managers/MarksManager.ts","helpers/fio.ts","components/work/GoogleTableFetch/index.tsx","managers/ReportManager.ts","components/work/WorkerDialog/index.tsx","components/work/GoogleTableFetch/GoogleTableFetchForm.tsx","components/shared/SessionExpiredAlert.tsx","components/work/LoadingPane/index.tsx","components/work/WorkPage/index.tsx","components/work/WorkPageContainer.tsx","App.tsx","reportWebVitals.ts","index.tsx"],"names":["StorageType","StatusCode","brsUrl","BrsUrlProvider","withProxy","this","save","name","data","whereTo","json","JSON","stringify","Local","LocalAndSession","localStorage","setItem","Session","sessionStorage","read","whereFrom","content","getItem","parse","clear","storageType","removeItem","LoginStatus","CustomError","statusCode","message","BrsAuth","brsUrlProvider","_sid","_safeUserName","_userName","BrsUnauthorized","a","loginInfo","cache","saveLoginInfo","sid","userName","checkSidAsync","sidCheckResult","success","request","method","url","baseUrl","headers","response","match","login","password","requestSidAsync","Error","cookie","result","checkResult","InvalidCredentials","Succeed","safeUserName","replaceAll","body","resolveWithFullResponse","simple","then","x","DISCOVERY_DOCS","GoogleAuth","gapi","client","Promise","resolve","load","init","clientId","discoveryDocs","scope","catch","console","error","auth2","getAuthInstance","isSignedIn","get","basicProfile","currentUser","getBasicProfile","getName","getEmail","signOut","Context","createContext","SubmitWithLoading","props","title","loading","className","onClick","disabled","Button","type","fullWidth","variant","color","CircularProgress","size","TABLE_URL_PATTERN","BrsLoginForm","onSubmit","submitting","signedIn","onLogout","React","useState","setLogin","setPassword","setSid","Fragment","e","preventDefault","TextField","margin","id","label","autoFocus","value","onChange","target","autoComplete","href","rel","GoogleLoginButton","onSignedIn","onFailure","Container","buttonText","onSuccess","CustomAlert","open","onClose","Snackbar","autoHideDuration","anchorOrigin","vertical","horizontal","severity","Alert","elevation","LoginPage","handleBrsSubmit","credentials","setState","submitLoading","loginBrsAsync","loginStatus","alertMessage","openAlert","alertType","brsAuthorized","brsAuth","authBySidAsync","loginAsync","handleCloseAlert","handleGoogleSignedIn","googleAuthorized","handleGoogleLoginFailed","startWork","redirect","handleBrsLogout","logout","handleGoogleLogout","googleAuth","renderGreeting","renderBrsLogin","state","brsLoading","renderGoogleLogin","getUserName","renderStartWorkButton","tryRestoreAsync","ensureInitializedAsync","checkAuth","checkAuthorized","to","component","maxWidth","Component","LoginPageContainer","Consumer","context","StudentFailure","TermType","BrsApi","year","termType","course","isModule","cacheName","getDisciplineCacheName","cacheResult","getDisciplineTotalAsync","total","getDisciplineInternalAsync","queryString","requestApiJsonAsync","paging","disciplines","moduleParameter","discipline","getStudentMarksAsync","students","uniqueStudents","s","knownStudent","studentUuid","Object","keys","map","k","cardType","markType","getStudentMarksInternalAsync","disciplineLoad","groupHistoryId","groupId","groupUuid","techgroup","isTotal","showActiveStudents","groupPart","getControlActionsCachedAsync","getControlActionsInternalAsync","modulePart","requestApiAsync","prefix","suffix","linesWithId","split","trim","filter","startsWith","length","columns","substr","uuidPrefix","c","uuid","uuidWithoutPrefix","controlAction","controlActionId","mark","cardTypeKey","disciplineLoadUuid","isNaN","toString","studentFailure","NoFailure","updateMarksAsync","updateMarksInternalAsync","uri","options","trimLeft","getSpreadsheet","spreadsheetId","sheets","range","spreadsheets","values","readAsync","getSpreadsheetProperties","res","sheetProps","properties","normalizeString","str","toLowerCase","replace","compareNormalized","s1","s2","parseAnyFloat","parseFloat","groupBy","items","key","reduce","reducer","item","itemKey","push","pluralize","count","version1","version2","version5","failureMapping","NotChosen","NotAllowedByDeansOffice","NotAppeared","Неуважительная","DisrespectfulReason","Уважительная","RespectfulReason","NotAllowedByTeacher","ShouldNotPass","AcademicLeave","Выбыл","DroppedOut","parseStudentFailure","input","undefined","formatStudentFailure","SpreadsheetManager","sheetName","readRowsFromSpreadsheetAsync","rows","header","getHeader","indices","buildIndicesBy","dataRange","buildDataRange","controlActionConfigs","buildControlActionConfig","disciplineConfig","buildDisciplineConfig","readStudentsAsync","fullNameColumn","left","groupColumn","failureColumn","actualStudents","readRange","fullNameIndex","groupNameIndex","idIndex","failureIndex","sheet","googleApi","row","fullName","groupName","failure","normalizedHeader","groupColumnIndex","indexOf","fullNameColumnIndex","failureColumnIndex","disciplineParameterKeyColumnIndex","disciplineParameterValueColumnIndex","Math","abs","disciplineKeyColumn","disciplineValueColumn","min","right","leftLetter","String","fromCharCode","charCodeAt","rightLetter","index","controlActions","propertyIndex","config","sameColumns","matchCount","matchIndex","Fall","defaultStudentFailure","i","addDisciplineConfigParameter","parseInt","yearParts","Spring","lowerValue","NestedList","icons","listSubheader","ListSubheader","hidden","List","aria-labelledby","subheader","renderNestedItems","ListItem","ListItemText","primary","level","NestedListItem","nestedItems","colored","collapsed","setOpen","hasSubItems","icon","IconPlace","ListItemIcon","button","style","paddingLeft","ExpandLess","ExpandMore","Collapse","in","unmountOnExit","disablePadding","RunWorkerButtons","enabled","onRunWorkSafe","onRunWorkUnsafe","Grid","container","justify","MarkUpdateStatus","toKey","fio","MarksManager","brsApi","reportManager","cancelPending","spreadsheetData","newReport","group","putMarksForDisciplineAsync","cancelReport","finishReport","getAllControlActionsCachedAsync","checkControlActionsConfiguration","getAllStudentMarksAsync","brsStudents","mergeStudents","mergedStudents","skippedActualStudents","skippedBrsStudents","logMergedStudents","putMarksForStudentsAsync","updateFailuresForSkippedStudentsAsync","updateAllMarksAsync","getSuitableControlAction","all","student","putMarksForStudentAsync","ratingResults","groupedResults","entries","rawStudents","formatMarkUpdateStatus","infoString","currentReport","marks","updated","failed","brsMarkString","brs","brsMark","actualMarkString","actual","actualMark","needUpdateMark","actualMarkOutput","putStudentMarkAsync","brsFailureStatus","actualFailure","failureStatus","putStudentFailureAsync","status","Failed","Updated","Skipped","studentName","join","suitableControlActions","some","b","errorMessages","onInvalidConfiguration","updateFailureForStudent","skipped","studentFio","description","activeBrsStudents","isStudentActive","actualStudent","suitableStudents","brsStudent","brsFullName","actualFullName","areStudentsLike","ms","report","merge","succeed","failedActual","failedBrs","studentStatus","LastAction","ReportManager","onReportFinished","_currentReport","DialogContent","withStyles","root","padding","MuiDialogContent","DialogActions","display","justifyContent","MuiDialogActions","WorkerDialog","marksManager","logConfigurationErrors","logItems","logMessage","reportToNestedListItems","marksData","suitableDisciplines","putMarksToBrsAsync","onError","okLoading","cancelWork","cancel","mainItem","hasErrors","mergeResultsTitle","failedActualCount","failedBrsCount","mergeInfoItem","marksItem","skippedItem","Dialog","dividers","onClosed","GoogleTableFetchForm","tableUrl","setTableUrl","urlError","setUrlError","regExp","spreadsheetInfo","groups","maybeSheetId","sheetId","event","helperText","required","GoogleTableFetch","workerSaveMode","loadDisciplines","getActualSpreadsheetDataAsync","getActualDisciplinesAsync","disciplinesInfo","disciplinesToListItems","showDisciplines","lastAction","LoadDisciplines","allDisciplinesMissed","allMissed","missedDisciplinesCount","missedCount","showWorkerButtons","updateCachedDisciplines","clearDisciplineCacheAsync","runWork","RunWork","runWorker","handleRunWorkSafe","handleRunWorkUnsafe","handleWorkerClosed","None","tableUrlError","availableDisciplines","actualGroups","Set","availableGroups","Array","from","groupMissed","has","getDisciplineCachedAsync","allDisciplines","d","getSheetName","spreadsheetManager","getSpreadsheetDataAsync","spreadsheetProperties","maybeSheet","ViewModule","memo","Transition","forwardRef","ref","Slide","direction","SessionExpiredAlert","sessionName","onOk","TransitionComponent","keepMounted","aria-describedby","DialogTitle","DialogContentText","LoadingPane","WorkPage","handleError","errorMessage","handleSessionExpired","openSessionExpiredAlert","handleSessionExpiredOk","returnToLoginPage","closeError","showControls","marginTop","WorkPageContainer","urlProvider","App","Provider","hashType","path","exact","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","document","getElementById"],"mappings":"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","file":"static/js/main.fee9e53f.chunk.js","sourcesContent":["export enum StorageType {\r\n  Local,\r\n  Session,\r\n  LocalAndSession,\r\n}\r\n\r\nexport function save(\r\n  name: string,\r\n  data: object | string,\r\n  whereTo: StorageType\r\n) {\r\n  if (!data) {\r\n    return false;\r\n  }\r\n\r\n  const json = JSON.stringify(data);\r\n\r\n  if (whereTo === StorageType.Local || whereTo === StorageType.LocalAndSession)\r\n    localStorage.setItem(name, json);\r\n  if (\r\n    whereTo === StorageType.Session ||\r\n    whereTo === StorageType.LocalAndSession\r\n  )\r\n    sessionStorage.setItem(name, json);\r\n\r\n  return true;\r\n}\r\n\r\nexport function read<T extends object | string>(\r\n  name: string,\r\n  whereFrom: StorageType\r\n) {\r\n  let content: string | null = null;\r\n\r\n  if (whereFrom === StorageType.Local) content = localStorage.getItem(name);\r\n  if (whereFrom === StorageType.Session) content = sessionStorage.getItem(name);\r\n  if (whereFrom === StorageType.LocalAndSession)\r\n    content = sessionStorage.getItem(name) ?? localStorage.getItem(name);\r\n\r\n  if (!content) {\r\n    return null;\r\n  }\r\n\r\n  const data = JSON.parse(content);\r\n  return data ? (data as T) : null;\r\n}\r\n\r\nexport function clear(name: string, storageType: StorageType) {\r\n  if (\r\n    storageType === StorageType.Local ||\r\n    storageType === StorageType.LocalAndSession\r\n  )\r\n    localStorage.removeItem(name);\r\n  if (\r\n    storageType === StorageType.Session ||\r\n    storageType === StorageType.LocalAndSession\r\n  )\r\n    sessionStorage.removeItem(name);\r\n\r\n  return true;\r\n}\r\n","export enum StatusCode {\r\n  BrsUnauthorized = 1,\r\n  GoogleUnauthorized,\r\n}\r\n\r\nexport default class CustomError {\r\n  readonly message: string;\r\n  readonly statusCode: StatusCode;\r\n\r\n  constructor(statusCode: StatusCode, message: string = \"\") {\r\n    this.statusCode = statusCode;\r\n    this.message = message;\r\n  }\r\n}\r\n","const brsUrl = \"https://brs.urfu.ru/mrd\";\r\nconst corsProxy = \"https://kamikoto-cors-proxy.herokuapp.com\";\r\n\r\nexport default class BrsUrlProvider {\r\n  private readonly withProxy: boolean;\r\n\r\n  constructor(withProxy: boolean) {\r\n    this.withProxy = withProxy;\r\n  }\r\n\r\n  get baseUrl() {\r\n    return this.withProxy ? `${corsProxy}/${brsUrl}` : brsUrl;\r\n  }\r\n}\r\n","import request from \"request-promise\";\r\nimport BrsUrlProvider from \"./BrsUrlProvider\";\r\nimport * as cache from \"../helpers/cache\";\r\nimport { StorageType } from \"../helpers/cache\";\r\nimport CustomError, { StatusCode } from \"../helpers/CustomError\";\r\n\r\nexport enum LoginStatus {\r\n  Succeed,\r\n  InvalidCredentials,\r\n  Error,\r\n}\r\n\r\nexport default class BrsAuth {\r\n  readonly brsUrlProvider: BrsUrlProvider;\r\n\r\n  constructor(brsUrlProvider: BrsUrlProvider) {\r\n    this.brsUrlProvider = brsUrlProvider;\r\n  }\r\n\r\n  private _sid: string | null = null;\r\n\r\n  get sid() {\r\n    if (!this._sid)\r\n      throw new CustomError(StatusCode.BrsUnauthorized, \"Нет авторизации в БРС\");\r\n    return this._sid;\r\n  }\r\n\r\n  private _safeUserName: string | null = null;\r\n\r\n  get safeUserName() {\r\n    if (!this._safeUserName)\r\n      throw new CustomError(StatusCode.BrsUnauthorized, \"Нет авторизации в БРС\");\r\n    return this._safeUserName;\r\n  }\r\n\r\n  private _userName?: string = \"Anonymous\";\r\n\r\n  get userName() {\r\n    return this._userName;\r\n  }\r\n\r\n  checkAuth() {\r\n    return !!(this._sid && this._safeUserName);\r\n  }\r\n\r\n  async tryRestoreAsync() {\r\n    if (!!(this._sid && this._safeUserName)) return;\r\n\r\n    let loginInfo = cache.read<LoginInfo>(\"loginInfo\", StorageType.Session);\r\n    if (loginInfo) {\r\n      this.saveLoginInfo(loginInfo.sid, loginInfo.userName);\r\n      return;\r\n    }\r\n\r\n    loginInfo = cache.read<LoginInfo>(\"loginInfo\", StorageType.Local);\r\n    if (!loginInfo) return;\r\n\r\n    const sidCheckResult = await this.checkSidAsync(loginInfo.sid);\r\n    if (sidCheckResult?.success)\r\n      this.saveLoginInfo(loginInfo.sid, loginInfo.userName);\r\n  }\r\n\r\n  private async checkSidAsync(sid: string): Promise<SidCheckResult | null> {\r\n    try {\r\n      const response: string = await request({\r\n        method: \"GET\",\r\n        url: this.brsUrlProvider.baseUrl + \"/mvc/mobile\",\r\n        headers: {\r\n          \"X-Cookie\": `JSESSIONID=${sid}`,\r\n          \"X-Requested-With\": \"XMLHttpRequest\",\r\n        },\r\n      });\r\n\r\n      const userName = response.match(/username\">([А-ЯЁа-яё -]+)</);\r\n      if (userName) return { success: true, userName: userName[1] };\r\n      return { success: false, userName: \"Anonymous\" };\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async loginAsync(login: string, password: string): Promise<LoginStatus> {\r\n    const response = await this.requestSidAsync(login, password);\r\n\r\n    if (!response || !(\"x-set-cookie\" in response.headers)) {\r\n      return LoginStatus.Error;\r\n    }\r\n\r\n    const cookie = response.headers[\"x-set-cookie\"] as string;\r\n    const result = cookie.match(/(?<=JSESSIONID=)\\w+/);\r\n\r\n    if (!result) return LoginStatus.Error;\r\n\r\n    const sid = result[0];\r\n\r\n    const checkResult = await this.checkSidAsync(sid);\r\n    if (checkResult === null) return LoginStatus.Error;\r\n    if (!checkResult.success) return LoginStatus.InvalidCredentials;\r\n\r\n    this.saveLoginInfo(sid, checkResult.userName);\r\n\r\n    return LoginStatus.Succeed;\r\n  }\r\n\r\n  async authBySidAsync(sid: string): Promise<LoginStatus> {\r\n    if (!sid) return LoginStatus.InvalidCredentials;\r\n\r\n    const checkResult = await this.checkSidAsync(sid);\r\n    if (checkResult === null) return LoginStatus.Error;\r\n    if (!checkResult.success) return LoginStatus.InvalidCredentials;\r\n\r\n    this.saveLoginInfo(sid, checkResult.userName);\r\n\r\n    return LoginStatus.Succeed;\r\n  }\r\n\r\n  private saveLoginInfo(sid: string, userName: string) {\r\n    const safeUserName = userName.replaceAll(/[^A-Za-zА-ЯЁа-яё]/g, \"_\");\r\n\r\n    cache.save(\r\n      \"loginInfo\",\r\n      { sid, safeUserName, userName },\r\n      StorageType.LocalAndSession\r\n    );\r\n\r\n    this._sid = sid;\r\n    this._safeUserName = safeUserName;\r\n    this._userName = userName;\r\n  }\r\n\r\n  logout() {\r\n    this._sid = null;\r\n    this._safeUserName = null;\r\n    cache.clear(\"loginInfo\", StorageType.LocalAndSession);\r\n  }\r\n\r\n  private async requestSidAsync(login: string, password: string) {\r\n    return await request({\r\n      url: this.brsUrlProvider.baseUrl + `/login`,\r\n      method: \"POST\",\r\n      body: `username=${login}&password=${password}`,\r\n      resolveWithFullResponse: true,\r\n      simple: false,\r\n      headers: {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded; charset=UTF-8\",\r\n      },\r\n    }).then(\r\n      (x) => x,\r\n      () => null\r\n    );\r\n  }\r\n}\r\n\r\ninterface LoginInfo {\r\n  sid: string;\r\n  safeUserName: string;\r\n  userName: string;\r\n}\r\n\r\ninterface SidCheckResult {\r\n  success: boolean;\r\n  userName: string;\r\n}\r\n","const CLIENT_ID =\r\n  \"122993083593-pacve8csj86voko30ia65raeg0ncrtuv.apps.googleusercontent.com\";\r\nconst DISCOVERY_DOCS = [\r\n  \"https://sheets.googleapis.com/$discovery/rest?version=v4\",\r\n];\r\nconst SCOPES = \"profile email https://www.googleapis.com/auth/spreadsheets\";\r\n\r\nexport default class GoogleAuth {\r\n  async ensureInitializedAsync() {\r\n    if (gapi.client) return;\r\n    return new Promise<void>((resolve) => {\r\n      gapi.load(\"client:auth2\", async () => {\r\n        await gapi.client\r\n          .init({\r\n            clientId: CLIENT_ID,\r\n            discoveryDocs: DISCOVERY_DOCS,\r\n            scope: SCOPES,\r\n          })\r\n          .catch(console.error);\r\n        resolve();\r\n      });\r\n    });\r\n  }\r\n\r\n  checkAuthorized() {\r\n    return gapi.auth2?.getAuthInstance()?.isSignedIn?.get();\r\n  }\r\n\r\n  getUserName(): string | undefined {\r\n    const basicProfile = gapi.auth2\r\n      ?.getAuthInstance()\r\n      ?.currentUser?.get()\r\n      ?.getBasicProfile();\r\n    return basicProfile?.getName() || basicProfile?.getEmail();\r\n  }\r\n\r\n  async logout() {\r\n    await gapi.auth2?.getAuthInstance()?.signOut();\r\n  }\r\n}\r\n","import { createContext } from \"react\";\r\nimport BrsAuth from \"./apis/BrsAuth\";\r\nimport BrsApi from \"./apis/BrsApi\";\r\nimport GoogleAuth from \"./apis/GoogleAuth\";\r\n\r\nconst Context =\r\n  createContext<{\r\n    brsAuth: BrsAuth;\r\n    brsApi: BrsApi;\r\n    googleAuth: GoogleAuth;\r\n  } | null>(null);\r\n\r\nexport default Context;\r\n","import { Button, CircularProgress } from \"@material-ui/core\";\r\nimport React from \"react\";\r\nimport \"./styles.css\";\r\n\r\nexport default function SubmitWithLoading(props: Props) {\r\n  const { title, loading, className, onClick, disabled = false } = props;\r\n\r\n  return (\r\n    <div className={\"submit-with-loading \" + className}>\r\n      <Button\r\n        type=\"submit\"\r\n        fullWidth\r\n        variant=\"contained\"\r\n        color=\"primary\"\r\n        onClick={onClick}\r\n        disabled={loading || disabled}\r\n      >\r\n        {title}\r\n      </Button>\r\n      {loading && (\r\n        <CircularProgress\r\n          color=\"secondary\"\r\n          size={24}\r\n          className=\"button-progress\"\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  title: string;\r\n  loading: boolean;\r\n  className?: string;\r\n  onClick?: () => void;\r\n  disabled?: boolean;\r\n}\r\n","export const SID_GAINING_INSTRUCTION_URL =\r\n  \"https://docs.google.com/document/d/1btXePo-5bE8RyX7RFXnBuS-UN9SmwUithpc_UXhAWsg/edit\";\r\n\r\nexport const TABLE_URL_PATTERN =\r\n  \"https://docs.google.com/spreadsheets/d/1Owzl3JfmFASIdC7ZMMw-0kkA3pwFSab1QdVO5dhZoxY/edit#gid=675912523\";\r\n\r\nexport const TABLE_TEMPLATE_URL =\r\n  \"https://docs.google.com/spreadsheets/d/sjwa1/edit#gid=0\";\r\n","import { Button, CircularProgress, TextField } from \"@material-ui/core\";\r\nimport SubmitWithLoading from \"../../shared/SubmitWithLoading\";\r\nimport React, { FormEvent } from \"react\";\r\nimport \"./styles.css\";\r\nimport { SID_GAINING_INSTRUCTION_URL } from \"../../../Constants\";\r\n\r\nexport default function BrsLoginForm({\r\n  onSubmit,\r\n  submitting,\r\n  loading,\r\n  signedIn,\r\n  onLogout,\r\n  userName,\r\n}: Props) {\r\n  const [login, setLogin] = React.useState(\"\");\r\n  const [password, setPassword] = React.useState(\"\");\r\n  const [sid, setSid] = React.useState(\"\");\r\n\r\n  function handleUserNameChanged(e: React.ChangeEvent<HTMLInputElement>) {\r\n    const value = e.target.value;\r\n    setLogin(value);\r\n    setSid(\"\");\r\n  }\r\n\r\n  function handlePasswordChanged(e: React.ChangeEvent<HTMLInputElement>) {\r\n    const value = e.target.value;\r\n    setPassword(value);\r\n    setSid(\"\");\r\n  }\r\n\r\n  function handleSidChanged(e: React.ChangeEvent<HTMLInputElement>) {\r\n    const value = e.target.value;\r\n    setSid(value);\r\n    setLogin(\"\");\r\n    setPassword(\"\");\r\n  }\r\n\r\n  function handleSubmit(e: FormEvent) {\r\n    e.preventDefault();\r\n\r\n    if (loading) return;\r\n\r\n    onSubmit({ login: login, password, sid });\r\n  }\r\n\r\n  return signedIn ? (\r\n    <React.Fragment>\r\n      <p>Добро пожаловать, {userName}</p>\r\n      <Button\r\n        type=\"button\"\r\n        fullWidth\r\n        variant=\"contained\"\r\n        onClick={onLogout}\r\n        color=\"primary\"\r\n      >\r\n        Выйти из БРС\r\n      </Button>\r\n    </React.Fragment>\r\n  ) : (\r\n    <div className=\"brs-login-form\">\r\n      <p>\r\n        <b>Войдите в БРС</b>, чтобы сервис мог получить информацию о ваших\r\n        курсах и выставлять оценки от вашего имени\r\n      </p>\r\n      <p>Это можно сделать через учетную запись БРС</p>\r\n      <form className=\"form\" onSubmit={handleSubmit}>\r\n        <TextField\r\n          className=\"form-component\"\r\n          variant=\"outlined\"\r\n          margin=\"normal\"\r\n          fullWidth\r\n          id=\"username\"\r\n          label=\"Имя пользователя\"\r\n          name=\"username\"\r\n          autoFocus\r\n          value={login}\r\n          disabled={loading}\r\n          onChange={handleUserNameChanged}\r\n        />\r\n        <TextField\r\n          className=\"form-component\"\r\n          variant=\"outlined\"\r\n          margin=\"normal\"\r\n          fullWidth\r\n          name=\"password\"\r\n          label=\"Пароль\"\r\n          type=\"password\"\r\n          id=\"password\"\r\n          autoComplete=\"current-password\"\r\n          value={password}\r\n          disabled={loading}\r\n          onChange={handlePasswordChanged}\r\n        />\r\n        <p className=\"form-component text-align-center\">\r\n          или через JSESSIONID при использовании единой учетной записи УрФУ\r\n        </p>\r\n        <TextField\r\n          className=\"form-component\"\r\n          variant=\"outlined\"\r\n          margin=\"normal\"\r\n          fullWidth\r\n          name=\"sid\"\r\n          label=\"JSESSIONID\"\r\n          type=\"password\"\r\n          id=\"sid\"\r\n          value={sid}\r\n          disabled={loading}\r\n          onChange={handleSidChanged}\r\n        />\r\n        <a\r\n          href={SID_GAINING_INSTRUCTION_URL}\r\n          className=\"button-link\"\r\n          target=\"_blank\"\r\n          rel=\"noreferrer\"\r\n        >\r\n          Как получить JSESSIONID\r\n        </a>\r\n        <SubmitWithLoading\r\n          className=\"vertical-margin-medium\"\r\n          title=\"войти\"\r\n          loading={submitting}\r\n          disabled={loading}\r\n        />\r\n      </form>\r\n      {loading && (\r\n        <CircularProgress color=\"primary\" size={150} className=\"progress\" />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  submitting: boolean;\r\n  loading: boolean;\r\n  onSubmit: (credentials: Credentials) => void;\r\n  onLogout: () => void;\r\n  signedIn: boolean;\r\n  userName?: string;\r\n}\r\n\r\nexport interface Credentials {\r\n  login: string;\r\n  password: string;\r\n  sid: string;\r\n}\r\n","import GoogleLogin from \"react-google-login\";\r\nimport React from \"react\";\r\nimport { Button, Container } from \"@material-ui/core\";\r\n\r\nconst CLIENT_ID =\r\n  \"122993083593-pacve8csj86voko30ia65raeg0ncrtuv.apps.googleusercontent.com\";\r\nconst SCOPES = \"profile email https://www.googleapis.com/auth/spreadsheets\";\r\n\r\nexport default function GoogleLoginButton(props: Props) {\r\n  const { onSignedIn, onFailure, signedIn, userName, onLogout } = props;\r\n\r\n  return (\r\n    <React.Fragment>\r\n      {signedIn ? (\r\n        <Container className=\"text-align-center\">\r\n          <p>Добро пожаловать, {userName}</p>\r\n          <Button\r\n            type=\"button\"\r\n            fullWidth\r\n            variant=\"contained\"\r\n            onClick={onLogout}\r\n            color=\"primary\"\r\n          >\r\n            Выйти из Google\r\n          </Button>\r\n        </Container>\r\n      ) : (\r\n        <Container className=\"text-align-center\">\r\n          <p>\r\n            <b>Войдите в Google</b>, чтобы сервис мог загружать оценки студентов\r\n            из ваших Google&nbsp;Таблиц\r\n          </p>\r\n          <GoogleLogin\r\n            clientId={CLIENT_ID}\r\n            buttonText=\"Войти в аккаунт Google\"\r\n            onSuccess={onSignedIn}\r\n            onFailure={onFailure}\r\n            scope={SCOPES}\r\n            isSignedIn={true}\r\n          />\r\n        </Container>\r\n      )}\r\n    </React.Fragment>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  onSignedIn: () => void;\r\n  onFailure: (error: any) => void;\r\n  onLogout: () => void;\r\n  signedIn: boolean;\r\n  userName?: string;\r\n}\r\n","import React from \"react\";\r\nimport MuiAlert, { AlertProps } from \"@material-ui/lab/Alert\";\r\nimport { Snackbar } from \"@material-ui/core\";\r\n\r\nexport default function CustomAlert(props: Props) {\r\n  const { open, message, type, onClose } = props;\r\n\r\n  return (\r\n    <React.Fragment>\r\n      <Snackbar\r\n        open={open}\r\n        autoHideDuration={10000}\r\n        anchorOrigin={{ vertical: \"top\", horizontal: \"center\" }}\r\n        onClose={onClose}\r\n      >\r\n        <Alert severity={type} onClose={onClose}>\r\n          {message}\r\n        </Alert>\r\n      </Snackbar>\r\n    </React.Fragment>\r\n  );\r\n}\r\n\r\nfunction Alert(props: AlertProps) {\r\n  return <MuiAlert elevation={6} variant=\"filled\" {...props} />;\r\n}\r\n\r\ninterface Props {\r\n  open: boolean;\r\n  message: string;\r\n  type: \"error\" | \"success\";\r\n  onClose: () => void;\r\n}\r\n","import React from \"react\";\r\nimport \"./styles.css\";\r\nimport { Redirect } from \"react-router-dom\";\r\nimport { Button, Container } from \"@material-ui/core\";\r\nimport BrsAuth, { LoginStatus } from \"../../../apis/BrsAuth\";\r\nimport BrsLoginForm, { Credentials } from \"../BrsLoginForm\";\r\nimport GoogleAuth from \"../../../apis/GoogleAuth\";\r\nimport GoogleLoginButton from \"../GoogleLoginButton\";\r\nimport CustomAlert from \"../../shared/CustomAlert\";\r\nimport { TABLE_URL_PATTERN } from \"../../../Constants\";\r\n\r\nexport default class LoginPage extends React.Component<Props, State> {\r\n  constructor(props: Props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      brsLoading: true,\r\n      brsAuthorized: false,\r\n      googleAuthorized: false,\r\n      redirect: false,\r\n      submitLoading: false,\r\n      openAlert: false,\r\n      alertMessage: \"\",\r\n      alertType: \"error\",\r\n    };\r\n  }\r\n\r\n  async componentDidMount() {\r\n    await this.props.brsAuth.tryRestoreAsync();\r\n    await this.props.googleAuth.ensureInitializedAsync();\r\n\r\n    const brsAuthorized = this.props.brsAuth.checkAuth();\r\n    const googleAuthorized = this.props.googleAuth.checkAuthorized();\r\n    this.setState({ brsLoading: false, brsAuthorized, googleAuthorized });\r\n  }\r\n\r\n  handleBrsSubmit = async (credentials: Credentials) => {\r\n    this.setState({ submitLoading: true });\r\n\r\n    const loginStatus = await this.loginBrsAsync(credentials);\r\n\r\n    this.setState({ submitLoading: false });\r\n\r\n    switch (loginStatus) {\r\n      case LoginStatus.Succeed:\r\n        this.setState({\r\n          alertMessage: \"Авторизация прошла успешно\",\r\n          openAlert: true,\r\n          alertType: \"success\",\r\n          brsAuthorized: true,\r\n        });\r\n        break;\r\n      case LoginStatus.Error:\r\n        this.setState({\r\n          alertMessage: \"Что-то пошло не так :( Попробуйте позже\",\r\n          openAlert: true,\r\n          alertType: \"error\",\r\n        });\r\n        break;\r\n      case LoginStatus.InvalidCredentials:\r\n        this.setState({\r\n          alertMessage: \"Неверные логин, пароль или JSESSIONID\",\r\n          openAlert: true,\r\n          alertType: \"error\",\r\n        });\r\n    }\r\n  };\r\n\r\n  loginBrsAsync = async (credentials: Credentials): Promise<LoginStatus> => {\r\n    if (credentials.sid) {\r\n      return await this.props.brsAuth.authBySidAsync(credentials.sid);\r\n    }\r\n    if (credentials.login && credentials.password) {\r\n      return await this.props.brsAuth.loginAsync(\r\n        credentials.login,\r\n        credentials.password\r\n      );\r\n    }\r\n    return LoginStatus.InvalidCredentials;\r\n  };\r\n\r\n  handleCloseAlert = () => {\r\n    this.setState({ openAlert: false });\r\n  };\r\n\r\n  handleGoogleSignedIn = () => {\r\n    this.setState({ googleAuthorized: true });\r\n  };\r\n\r\n  handleGoogleLoginFailed = (error: any) => {\r\n    console.error(error);\r\n\r\n    this.setState({\r\n      openAlert: true,\r\n      alertType: \"error\",\r\n      alertMessage: \"Не удалось подключить Ваш Google аккаунт :(\",\r\n    });\r\n  };\r\n\r\n  startWork = () => {\r\n    this.setState({ redirect: true });\r\n  };\r\n\r\n  handleBrsLogout = () => {\r\n    this.props.brsAuth.logout();\r\n    this.setState({\r\n      brsAuthorized: false,\r\n      alertMessage: \"Вы вышли из аккаунта БРС\",\r\n      alertType: \"success\",\r\n      openAlert: true,\r\n    });\r\n  };\r\n\r\n  handleGoogleLogout = async () => {\r\n    await this.props.googleAuth.logout();\r\n    this.setState({\r\n      googleAuthorized: false,\r\n      alertType: \"success\",\r\n      alertMessage: \"Вы вышли из аккаунта Google\",\r\n      openAlert: true,\r\n    });\r\n  };\r\n\r\n  renderGreeting = () => {\r\n    return (\r\n      <div className=\"greeting\">\r\n        <h2>Добро пожаловать в Расширения БРС</h2>\r\n        <h3 className=\"block-header\">Как все работает</h3>\r\n        <ol>\r\n          <li>\r\n            В Google&nbsp;Таблицах вы заполняете оценки за курс по некоторому{\" \"}\r\n            <a\r\n              href={TABLE_URL_PATTERN}\r\n              target=\"_blank\"\r\n              rel=\"noreferrer\"\r\n              className=\"button-link\"\r\n            >\r\n              шаблону\r\n            </a>\r\n          </li>\r\n          <li>\r\n            После этого импортируете Google Таблицу в сервис и выполняете\r\n            пробный запуск выставления оценок, чтобы исключить ошибки\r\n          </li>\r\n          <li>Наконец делаете запуск с реальным выставлением оценок</li>\r\n        </ol>\r\n        <h3 className=\"block-header\">Правила хранения данных</h3>\r\n        <p>\r\n          Ваш логин и пароль передаются в БРС и нигде не сохраняются\r\n          <br />\r\n          Данные о доступных вам курсах сохраняются только в вашем браузере\r\n        </p>\r\n        <hr />\r\n      </div>\r\n    );\r\n  };\r\n\r\n  renderBrsLogin = () => {\r\n    return (\r\n      <BrsLoginForm\r\n        onSubmit={this.handleBrsSubmit}\r\n        loading={this.state.brsLoading}\r\n        signedIn={this.state.brsAuthorized}\r\n        onLogout={this.handleBrsLogout}\r\n        userName={this.props.brsAuth.userName}\r\n        submitting={this.state.submitLoading}\r\n      />\r\n    );\r\n  };\r\n\r\n  renderGoogleLogin = () => {\r\n    return (\r\n      <GoogleLoginButton\r\n        onSignedIn={this.handleGoogleSignedIn}\r\n        signedIn={this.state.googleAuthorized}\r\n        userName={this.props.googleAuth.getUserName()}\r\n        onLogout={this.handleGoogleLogout}\r\n        onFailure={this.handleGoogleLoginFailed}\r\n      />\r\n    );\r\n  };\r\n\r\n  renderStartWorkButton = () => {\r\n    return (\r\n      <Button\r\n        variant=\"contained\"\r\n        onClick={this.startWork}\r\n        disabled={!this.state.brsAuthorized || !this.state.googleAuthorized}\r\n        color=\"secondary\"\r\n      >\r\n        начать работу\r\n      </Button>\r\n    );\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      <div className=\"login-page\">\r\n        {this.state.redirect && <Redirect to=\"/work\" />}\r\n        <Container component=\"main\" maxWidth=\"md\">\r\n          {this.renderGreeting()}\r\n          <Container maxWidth=\"xs\">\r\n            <Container>{this.renderBrsLogin()}</Container>\r\n            <hr className=\"vertical-margin-medium\" />\r\n            <Container>{this.renderGoogleLogin()}</Container>\r\n          </Container>\r\n          <Container className=\"text-align-center vertical-margin-large\">\r\n            {this.renderStartWorkButton()}\r\n          </Container>\r\n          <CustomAlert\r\n            open={this.state.openAlert}\r\n            message={this.state.alertMessage}\r\n            type={this.state.alertType}\r\n            onClose={this.handleCloseAlert}\r\n          />\r\n        </Container>\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\ninterface State {\r\n  brsLoading: boolean;\r\n  brsAuthorized: boolean;\r\n  googleAuthorized: boolean;\r\n  submitLoading: boolean;\r\n  redirect: boolean;\r\n  openAlert: boolean;\r\n  alertMessage: string;\r\n  alertType: \"error\" | \"success\";\r\n}\r\n\r\ninterface Props {\r\n  brsAuth: BrsAuth;\r\n  googleAuth: GoogleAuth;\r\n}\r\n","import React from \"react\";\r\nimport Context from \"../../Context\";\r\nimport LoginPage from \"./LoginPage\";\r\n\r\nexport default function LoginPageContainer() {\r\n  return (\r\n    <Context.Consumer>\r\n      {(context) =>\r\n        context && (\r\n          <LoginPage\r\n            brsAuth={context.brsAuth}\r\n            googleAuth={context.googleAuth}\r\n          />\r\n        )\r\n      }\r\n    </Context.Consumer>\r\n  );\r\n}\r\n","import \"bluebird\";\r\nimport request from \"request-promise\";\r\nimport * as cache from \"../helpers/cache\";\r\nimport { StorageType } from \"../helpers/cache\";\r\nimport BrsAuth from \"./BrsAuth\";\r\nimport BrsUrlProvider from \"./BrsUrlProvider\";\r\nimport CustomError, { StatusCode } from \"../helpers/CustomError\";\r\n\r\nexport enum StudentFailure {\r\n  /** -, дефис, все хорошо */ NoFailure = -1,\r\n  /** Не выбрана */ NotChosen = -19,\r\n  /** Не допущен (деканат) */ NotAllowedByDeansOffice = -18,\r\n  /** Не явился */ NotAppeared = 0,\r\n  /** Неуважительная */ DisrespectfulReason = 12,\r\n  /** Уважительная */ RespectfulReason = 13,\r\n  /** Не допущен */ NotAllowedByTeacher = 18,\r\n  /** Не должен сдавать */ ShouldNotPass = 19,\r\n  /** Академический отпуск */ AcademicLeave = 20,\r\n  /** Выбыл */ DroppedOut = 21,\r\n}\r\n\r\nexport enum TermType {\r\n  Fall = 1,\r\n  Spring = 2,\r\n}\r\n\r\nexport default class BrsApi {\r\n  readonly brsAuth: BrsAuth;\r\n  private readonly brsUrlProvider: BrsUrlProvider;\r\n\r\n  constructor(brsAuth: BrsAuth, brsUrlProvider: BrsUrlProvider) {\r\n    this.brsAuth = brsAuth;\r\n    this.brsUrlProvider = brsUrlProvider;\r\n  }\r\n\r\n  async getDisciplineCachedAsync(\r\n    year: number,\r\n    termType: TermType,\r\n    course: number,\r\n    isModule: boolean\r\n  ) {\r\n    const cacheName = this.getDisciplineCacheName(\r\n      year,\r\n      termType,\r\n      course,\r\n      isModule\r\n    );\r\n    const cacheResult = cache.read<Discipline[]>(cacheName, StorageType.Session);\r\n    if (cacheResult) {\r\n      return cacheResult;\r\n    }\r\n\r\n    const total = await this.getDisciplineTotalAsync(\r\n      year,\r\n      termType,\r\n      course,\r\n      isModule\r\n    );\r\n    const result = await this.getDisciplineInternalAsync(\r\n      year,\r\n      termType,\r\n      course,\r\n      isModule,\r\n      total\r\n    );\r\n    cache.save(cacheName, result, StorageType.Session);\r\n    return result;\r\n  }\r\n\r\n  async getDisciplineInternalAsync(\r\n    year: number,\r\n    termType: TermType,\r\n    course: number,\r\n    isModule: boolean,\r\n    total: number\r\n  ) {\r\n    const queryString = `?year=${year}&termType=${termType}&course=${course}&total=${total}&page=1&pageSize=${total}&search=`;\r\n    if (isModule) {\r\n      const paging = await this.requestApiJsonAsync<Paging<Discipline>>(\r\n        \"/mvc/mobile/module/fetch\" + queryString\r\n      );\r\n      const disciplines = paging.content;\r\n      for (const d of disciplines) {\r\n        d.isModule = true;\r\n      }\r\n      return disciplines;\r\n    } else {\r\n      const paging = await this.requestApiJsonAsync<Paging<Discipline>>(\r\n        \"/mvc/mobile/discipline/fetch\" + queryString\r\n      );\r\n      const disciplines = paging.content;\r\n      for (const d of disciplines) {\r\n        d.isModule = false;\r\n      }\r\n      return disciplines;\r\n    }\r\n  }\r\n\r\n  async clearDisciplineCacheAsync(\r\n    year: number,\r\n    termType: TermType,\r\n    course: number,\r\n    isModule: boolean\r\n  ) {\r\n    const cacheName = this.getDisciplineCacheName(\r\n      year,\r\n      termType,\r\n      course,\r\n      isModule\r\n    );\r\n    cache.clear(cacheName, StorageType.Session);\r\n  }\r\n\r\n  async getDisciplineTotalAsync(\r\n    year: number,\r\n    termType: TermType,\r\n    course: number,\r\n    isModule: boolean\r\n  ) {\r\n    const moduleParameter = isModule ? \"&its=true\" : \"\";\r\n    const queryString =\r\n      `?year=${year}&termType=${termType}&course=${course}` + moduleParameter;\r\n    const total = await this.requestApiJsonAsync<number>(\r\n      \"/mvc/mobile/discipline/amount\" + queryString\r\n    );\r\n    return total;\r\n  }\r\n\r\n  async getAllStudentMarksAsync(discipline: Discipline) {\r\n    const students = [\r\n      ...(await this.getStudentMarksAsync(discipline, \"lecture\", \"current\")),\r\n      ...(await this.getStudentMarksAsync(\r\n        discipline,\r\n        \"lecture\",\r\n        \"intermediate\"\r\n      )),\r\n      ...(await this.getStudentMarksAsync(discipline, \"laboratory\", \"current\")),\r\n      ...(await this.getStudentMarksAsync(\r\n        discipline,\r\n        \"laboratory\",\r\n        \"intermediate\"\r\n      )),\r\n    ];\r\n\r\n    const uniqueStudents: { [id: string]: StudentMark } = {};\r\n    for (const s of students) {\r\n      const knownStudent = uniqueStudents[s.studentUuid] || {};\r\n      uniqueStudents[s.studentUuid] = { ...knownStudent, ...s };\r\n    }\r\n\r\n    return Object.keys(uniqueStudents).map((k) => uniqueStudents[k]);\r\n  }\r\n\r\n  async getStudentMarksAsync(\r\n    discipline: Discipline,\r\n    cardType: CardType,\r\n    markType: MarkType\r\n  ) {\r\n    return this.getStudentMarksInternalAsync(\r\n      discipline.disciplineLoad,\r\n      discipline.isModule,\r\n      discipline.groupHistoryId,\r\n      discipline.groupId,\r\n      cardType,\r\n      markType\r\n    );\r\n  }\r\n\r\n  async getStudentMarksInternalAsync(\r\n    disciplineLoad: string,\r\n    isModule: boolean,\r\n    groupUuid: string,\r\n    techgroup: string,\r\n    cardType: CardType,\r\n    markType: MarkType,\r\n    isTotal: boolean = false,\r\n    showActiveStudents: boolean = false\r\n  ) {\r\n    const groupPart = isModule\r\n      ? `techgroup=${techgroup}`\r\n      : `groupUuid=${groupUuid}`;\r\n    return this.requestApiJsonAsync<StudentMark[]>(\r\n      `/mvc/mobile/studentMarks/fetch?disciplineLoad=${disciplineLoad}&${groupPart}` +\r\n        `&cardType=${cardType}&hasTest=false&isTotal=${isTotal}` +\r\n        `&intermediate=${markType === \"intermediate\"}` +\r\n        `&selectedTeachers=null&showActiveStudents=${showActiveStudents}`\r\n    );\r\n  }\r\n\r\n  async getAllControlActionsCachedAsync(discipline: Discipline) {\r\n    return [\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"lecture\",\r\n        \"current\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"lecture\",\r\n        \"intermediate\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"laboratory\",\r\n        \"current\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"laboratory\",\r\n        \"intermediate\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"practice\",\r\n        \"current\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"practice\",\r\n        \"intermediate\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"additionalPractice\",\r\n        \"current\"\r\n      )),\r\n      ...(await this.getControlActionsCachedAsync(\r\n        discipline,\r\n        \"additionalPractice\",\r\n        \"intermediate\"\r\n      )),\r\n    ];\r\n  }\r\n\r\n  async getControlActionsCachedAsync(\r\n    discipline: Discipline,\r\n    cardType: CardType,\r\n    markType: MarkType\r\n  ) {\r\n    const cacheName =\r\n      `${this.brsAuth.safeUserName}_getControlActions_${discipline.disciplineLoad}` +\r\n      `_${discipline.isModule}_${discipline.groupHistoryId}_${discipline.groupId}_${cardType}_${markType}`;\r\n    const cacheResult = cache.read<ControlAction[]>(\r\n      cacheName,\r\n      StorageType.Session\r\n    );\r\n    if (cacheResult) {\r\n      return cacheResult;\r\n    }\r\n\r\n    const result = await this.getControlActionsInternalAsync(\r\n      discipline.disciplineLoad,\r\n      discipline.isModule,\r\n      discipline.groupHistoryId,\r\n      discipline.groupId,\r\n      cardType,\r\n      markType\r\n    );\r\n    cache.save(cacheName, result, StorageType.Session);\r\n    return result;\r\n  }\r\n\r\n  async getControlActionsInternalAsync(\r\n    disciplineLoad: string,\r\n    isModule: boolean,\r\n    groupUuid: string,\r\n    techgroup: string,\r\n    cardType: CardType,\r\n    markType: MarkType\r\n  ) {\r\n    const modulePart = isModule ? \"/module\" : \"\";\r\n    const groupPart = isModule ? techgroup : groupUuid;\r\n    const response = await this.requestApiAsync<string>(\r\n      `/mvc/mobile/view/mark/${disciplineLoad}/${groupPart}/teachers${modulePart}/${cardType}/${markType}`\r\n    );\r\n\r\n    const prefix = \"gridColumns = toTextArray(\";\r\n    const suffix = \");\";\r\n    const linesWithId = response\r\n      .split(\"\\r\\n\")\r\n      .map((s) => s.trim())\r\n      .filter((s) => s.startsWith(prefix));\r\n    if (linesWithId.length !== 1) {\r\n      throw new Error(\r\n        \"Не удалось разобрать страницу БРС со списком контрольных мероприятий. Ожидается, что эта страница содержит единственную строчку с идентификатором техкарты.\"\r\n      );\r\n    }\r\n\r\n    const columns: Array<{ controlAction: string; uuid: string }> =\r\n      JSON.parse(\r\n        linesWithId[0].substr(\r\n          prefix.length,\r\n          linesWithId[0].length - prefix.length - suffix.length\r\n        )\r\n      ) || [];\r\n\r\n    const uuidPrefix = \"technologyCard\";\r\n    const result = columns\r\n      .filter((c) => c.uuid && c.uuid.startsWith(uuidPrefix))\r\n      .map((c) => ({\r\n        uuid: c.uuid,\r\n        uuidWithoutPrefix: c.uuid.substr(uuidPrefix.length),\r\n        controlAction: c.controlAction,\r\n      }));\r\n    return result as ControlAction[];\r\n  }\r\n\r\n  async putStudentMarkAsync(\r\n    studentUuid: string,\r\n    controlActionId: string,\r\n    mark: number,\r\n    groupId: string,\r\n    cardTypeKey: CardType,\r\n    disciplineLoadUuid: string\r\n  ) {\r\n    const body = `student=${studentUuid}&techcard=${controlActionId}&mark=${\r\n      isNaN(mark) ? \"\" : mark.toString()\r\n    }&groupId=${groupId}&cardTypeKey=${cardTypeKey}&disciplineLoadUuid=${disciplineLoadUuid}`;\r\n    return this.requestApiJsonAsync<StudentMark>(\r\n      `/mvc/mobile/studentMarks/put`,\r\n      {\r\n        method: \"POST\",\r\n        body,\r\n        json: false,\r\n      },\r\n      {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded; charset=UTF-8\",\r\n      }\r\n    );\r\n  }\r\n\r\n  async putStudentFailureAsync(\r\n    studentUuid: string,\r\n    discipline: Discipline,\r\n    studentFailure: StudentFailure = StudentFailure.NoFailure,\r\n    cardType: CardType = \"lecture\"\r\n  ) {\r\n    const body = `markFailure=${studentFailure}&cardType=${cardType}&disciplineLoad=${discipline.disciplineLoad}&studentId=${studentUuid}`;\r\n    await this.requestApiAsync(\r\n      `/mvc/mobile/failure/update`,\r\n      {\r\n        method: \"POST\",\r\n        body,\r\n        json: false,\r\n      },\r\n      {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded; charset=UTF-8\",\r\n      }\r\n    );\r\n  }\r\n\r\n  async updateAllMarksAsync(discipline: Discipline) {\r\n    // Одного вызова достаточно, чтобы обновить все оценки по предмету у группы.\r\n    await this.updateMarksAsync(discipline, \"lecture\", \"intermediate\");\r\n    // await updateMarksAsync(discipline, 'lecture', 'current');\r\n    // await updateMarksAsync(discipline, 'lecture', 'intermediate');\r\n    // await updateMarksAsync(discipline, 'laboratory', 'current');\r\n    // await updateMarksAsync(discipline, 'laboratory', 'intermediate');\r\n    // await updateMarksAsync(discipline, 'practice', 'current');\r\n    // await updateMarksAsync(discipline, 'practice', 'intermediate');\r\n  }\r\n\r\n  async updateMarksAsync(\r\n    discipline: Discipline,\r\n    cardType: CardType,\r\n    markType: MarkType\r\n  ) {\r\n    return this.updateMarksInternalAsync(\r\n      discipline.disciplineLoad,\r\n      discipline.isModule,\r\n      discipline.groupHistoryId,\r\n      discipline.groupId,\r\n      cardType,\r\n      markType\r\n    );\r\n  }\r\n\r\n  async updateMarksInternalAsync(\r\n    disciplineLoad: string,\r\n    isModule: boolean,\r\n    groupUuid: string,\r\n    techgroup: string,\r\n    cardType: CardType,\r\n    markType: MarkType\r\n  ) {\r\n    const modulePart = isModule ? \"/module\" : \"\";\r\n    const groupPart = isModule\r\n      ? `techgroup=${techgroup}`\r\n      : `groupUuid=${groupUuid}`;\r\n    const body =\r\n      `disciplineLoad=${disciplineLoad}&${groupPart}` +\r\n      `&cardType=${cardType}&hasTest=false&isTotal=false` +\r\n      `&intermediate=${markType === \"intermediate\"}` +\r\n      `&selectedTeachers=null&showActiveStudents=true`;\r\n    return this.requestApiAsync<string>(\r\n      `/mvc/mobile/updateMarks${modulePart}`,\r\n      {\r\n        method: \"POST\",\r\n        body,\r\n        json: false,\r\n      },\r\n      {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded; charset=UTF-8\",\r\n      }\r\n    );\r\n  }\r\n\r\n  getDisciplineCacheName(\r\n    year: number,\r\n    termType: TermType,\r\n    course: number,\r\n    isModule: boolean\r\n  ) {\r\n    return `${this.brsAuth.safeUserName}_getDiscipline_${year}_${termType}_${course}_${isModule}`;\r\n  }\r\n\r\n  async requestApiJsonAsync<T>(\r\n    uri: string,\r\n    options?: RequestOptions,\r\n    headers?: RequestHeaders\r\n  ): Promise<T> {\r\n    const response = await this.requestApiAsync<string>(uri, options, headers);\r\n\r\n    return JSON.parse(response);\r\n  }\r\n\r\n  async requestApiAsync<T>(\r\n    uri: string,\r\n    options?: RequestOptions,\r\n    headers?: RequestHeaders\r\n  ): Promise<T> {\r\n    const response = await request({\r\n      method: \"GET\",\r\n      ...options,\r\n      url: this.brsUrlProvider.baseUrl + uri,\r\n      headers: {\r\n        \"X-Cookie\": `JSESSIONID=${this.brsAuth.sid}`,\r\n        \"X-Requested-With\": \"XMLHttpRequest\",\r\n        ...headers,\r\n      },\r\n    });\r\n\r\n    if (response.trimLeft().startsWith(\"<!DOCTYPE html>\")) {\r\n      throw new CustomError(StatusCode.BrsUnauthorized, uri + \" is Forbidden\");\r\n    }\r\n\r\n    return response;\r\n  }\r\n}\r\n\r\nexport type CardType =\r\n  | \"lecture\"\r\n  | \"laboratory\"\r\n  | \"practice\"\r\n  | \"additionalPractice\";\r\nexport type MarkType = \"intermediate\" | \"current\";\r\n\r\nexport interface RegisterInfo {\r\n  registerInfoStr: string;\r\n  registerId: number;\r\n  passDate: any;\r\n  cardType: string;\r\n  sheet: string;\r\n}\r\n\r\nexport interface Discipline {\r\n  groupId: string;\r\n  discipline: string;\r\n  group: string;\r\n  registerInfo: RegisterInfo[];\r\n  disciplineLoad: string;\r\n  groupHistoryId: string;\r\n  isModule: boolean;\r\n}\r\n\r\n// eslint-disable-next-line\r\nconst studentMarkSample: StudentMark = {\r\n  studentPersonalNumber: \"09800106\",\r\n  isEdit: false,\r\n  studentUuid:\r\n    \"studen18hc2jg0000magk6mi3iec84bsundigr18hc2jg0000m53o7mlgvora278\",\r\n  status: 1,\r\n  studentStatus: \"Активный\",\r\n  ignoreCurrentDebars: false,\r\n  studentFio: \"Анисимова Маргарита Васильевна\",\r\n  isExtern: false,\r\n  teacherName: \"\",\r\n  cardType: \"lecture\",\r\n  studentName: \"Анисимова М.В.\",\r\n  studentGroup: \"РИ-180001\",\r\n  registerClosed: false,\r\n  subgroupsITS: \"\",\r\n  disciplineLoad: \"unpldd18hc2jg0000m5kojcd3te76bnk\",\r\n};\r\n\r\nexport interface StudentMark {\r\n  studentPersonalNumber: string;\r\n  isEdit: boolean;\r\n  studentUuid: string;\r\n  status: number;\r\n  studentStatus: string;\r\n  ignoreCurrentDebars: boolean;\r\n  studentFio: string;\r\n  isExtern: boolean;\r\n  teacherName: string;\r\n  cardType: CardType;\r\n  studentName: string;\r\n  studentGroup: string;\r\n  registerClosed: boolean;\r\n  subgroupsITS: string;\r\n  disciplineLoad: string;\r\n  failure?: StudentFailure;\r\n  failureName?: string;\r\n\r\n  [props: string]: number | string | boolean | undefined;\r\n}\r\n\r\nexport interface ControlAction {\r\n  uuid: string;\r\n  uuidWithoutPrefix: string;\r\n  controlAction: string;\r\n}\r\n\r\ninterface RequestOptions {\r\n  method?: string;\r\n  body?: object | string;\r\n  json?: boolean;\r\n}\r\n\r\ninterface RequestHeaders {\r\n  \"Content-Type\"?: string;\r\n}\r\n\r\ninterface Paging<T> {\r\n  content: T[];\r\n  last: boolean;\r\n  totalPages: number;\r\n  totalElements: number;\r\n  size: number;\r\n  number: number;\r\n  sort: any;\r\n  first: boolean;\r\n  numberOfElements: number;\r\n}\r\n","export function getSpreadsheet(spreadsheetId: string): Spreadsheet {\r\n  const sheets = gapi.client.sheets;\r\n\r\n  async function readAsync(range: string) {\r\n    const response = await sheets.spreadsheets.values.get({\r\n      spreadsheetId,\r\n      range,\r\n    });\r\n    return response.result;\r\n  }\r\n\r\n  return {\r\n    readAsync,\r\n  };\r\n}\r\n\r\nexport async function getSpreadsheetProperties(\r\n  spreadsheetId: string\r\n): Promise<SpreadsheetProperties[]> {\r\n  const sheets = gapi.client.sheets;\r\n\r\n  const res = await sheets.spreadsheets.get({ spreadsheetId });\r\n  const sheetProps = JSON.parse(res.body).sheets as [\r\n    { properties: SpreadsheetProperties }\r\n  ];\r\n  return sheetProps.map((s) => s.properties);\r\n}\r\n\r\nexport interface Spreadsheet {\r\n  readAsync: (range: string) => Promise<ValueRange>;\r\n}\r\n\r\nexport interface ValueRange {\r\n  majorDimension?: string | null;\r\n  range?: string | null;\r\n  values?: any[][] | null;\r\n}\r\n\r\nexport interface SpreadsheetProperties {\r\n  sheetId: number;\r\n  title: string;\r\n}\r\n","export function fixSpaces(str: string) {\r\n  return str && str.replace(/[\\s]/g, \" \");\r\n}\r\n\r\nexport function normalizeString(str: string) {\r\n  return (\r\n    str &&\r\n    str\r\n      .toLowerCase()\r\n      .replace(\"ё\", \"е\")\r\n      .replace(/[^A-Za-zА-ЯЁа-яё0-9]/g, \"\")\r\n  );\r\n}\r\n\r\nexport function compareNormalized(s1: string, s2: string) {\r\n  return normalizeString(s1) === normalizeString(s2);\r\n}\r\n\r\nexport function parseAnyFloat(s: string) {\r\n  return parseFloat(s && s.replace(\",\", \".\"));\r\n}\r\n\r\nexport function groupBy<TItem>(items: TItem[], key: keyof TItem) {\r\n  const reducer: { [group: string]: TItem[] } = {};\r\n  return items.reduce((reducer, item) => {\r\n    const itemKey = `${item[key]}`;\r\n    (reducer[itemKey] = reducer[itemKey] || []).push(item);\r\n    return reducer;\r\n  }, reducer);\r\n}\r\n\r\nexport function pluralize(\r\n  count: number,\r\n  version1: string,\r\n  version2: string,\r\n  version5: string\r\n) {\r\n  if (\r\n    count % 10 === 0 ||\r\n    count % 10 >= 5 ||\r\n    (count % 100 > 10 && count % 100 < 20)\r\n  )\r\n    return version5;\r\n  return count % 10 === 1 ? version1 : version2;\r\n}\r\n","import { StudentFailure } from \"../apis/BrsApi\";\r\nimport { compareNormalized } from \"./tools\";\r\n\r\nconst failureMapping: { [key: string]: StudentFailure } = {\r\n  \"-\": StudentFailure.NoFailure,\r\n  \"Не выбрана\": StudentFailure.NotChosen,\r\n  \"Не допущен (деканат)\": StudentFailure.NotAllowedByDeansOffice,\r\n  \"Не явился\": StudentFailure.NotAppeared,\r\n  Неуважительная: StudentFailure.DisrespectfulReason,\r\n  Уважительная: StudentFailure.RespectfulReason,\r\n  \"Не допущен\": StudentFailure.NotAllowedByTeacher,\r\n  \"Не должен сдавать\": StudentFailure.ShouldNotPass,\r\n  \"Академический отпуск\": StudentFailure.AcademicLeave,\r\n  Выбыл: StudentFailure.DroppedOut,\r\n};\r\n\r\nexport function parseStudentFailure(input: string): StudentFailure | null {\r\n  if (input === null || input === undefined) {\r\n    return null;\r\n  }\r\n\r\n  for (let key of Object.keys(failureMapping)) {\r\n    if (compareNormalized(key, input)) {\r\n      return failureMapping[key];\r\n    }\r\n  }\r\n\r\n  return StudentFailure.NoFailure;\r\n}\r\n\r\nexport function formatStudentFailure(\r\n  input: StudentFailure | null | undefined\r\n): string | null {\r\n  if (input === null || input === undefined) {\r\n    return null;\r\n  }\r\n\r\n  for (let key of Object.keys(failureMapping)) {\r\n    if (failureMapping[key] === input) {\r\n      return key;\r\n    }\r\n  }\r\n\r\n  return \"-\";\r\n}\r\n","import { StudentFailure, TermType } from \"../apis/BrsApi\";\r\nimport { ControlActionConfig } from \"./MarksManager\";\r\nimport * as googleApi from \"../apis/GoogleApi\";\r\nimport { compareNormalized, normalizeString } from \"../helpers/tools\";\r\nimport { parseStudentFailure } from \"../helpers/brsHelpers\";\r\n\r\nexport interface ActualStudent {\r\n  fullName: string;\r\n  groupName: string;\r\n  id: string | null;\r\n  failure: StudentFailure | null;\r\n  properties: string[];\r\n}\r\n\r\nexport interface SpreadsheetData {\r\n  actualStudents: ActualStudent[];\r\n  disciplineConfig: DisciplineConfig;\r\n  controlActionConfigs: ControlActionConfig[];\r\n}\r\n\r\nexport interface DisciplineConfig {\r\n  name: string;\r\n  year: number;\r\n  termType: number;\r\n  course: number;\r\n  isModule: boolean;\r\n  defaultStudentFailure: StudentFailure;\r\n}\r\n\r\nexport default class SpreadsheetManager {\r\n  private readonly spreadsheetId: string;\r\n\r\n  constructor(spreadsheetId: string) {\r\n    this.spreadsheetId = spreadsheetId;\r\n  }\r\n\r\n  async getSpreadsheetDataAsync(sheetName: string): Promise<SpreadsheetData> {\r\n    const rows = await readRowsFromSpreadsheetAsync(\r\n      this.spreadsheetId,\r\n      sheetName\r\n    );\r\n    const header = getHeader(rows);\r\n\r\n    const indices = buildIndicesBy(header);\r\n    const dataRange = buildDataRange(sheetName, indices);\r\n    const controlActionConfigs = buildControlActionConfig(header, indices);\r\n    const disciplineConfig = buildDisciplineConfig(rows, indices);\r\n\r\n    const actualStudents = await readStudentsAsync(\r\n      this.spreadsheetId,\r\n      dataRange,\r\n      indices.fullNameColumn - indices.left,\r\n      indices.groupColumn - indices.left,\r\n      null,\r\n      indices.failureColumn - indices.left\r\n    );\r\n\r\n    return {\r\n      actualStudents,\r\n      disciplineConfig,\r\n      controlActionConfigs,\r\n    };\r\n  }\r\n}\r\n\r\nasync function readStudentsAsync(\r\n  spreadsheetId: string,\r\n  readRange: string,\r\n  fullNameIndex: number = 0,\r\n  groupNameIndex: number = 1,\r\n  idIndex: number | null = null,\r\n  failureIndex: number | null = null\r\n) {\r\n  const sheet = googleApi.getSpreadsheet(spreadsheetId);\r\n\r\n  const rows = (await sheet.readAsync(readRange)).values || [];\r\n\r\n  const result: ActualStudent[] = [];\r\n  for (const row of rows) {\r\n    const fullName = row[fullNameIndex];\r\n    const groupName = row[groupNameIndex];\r\n    const id = idIndex !== null ? row[idIndex] : null;\r\n    const failure =\r\n      failureIndex !== null ? parseStudentFailure(row[failureIndex]) : null;\r\n    if (fullName && groupName) {\r\n      result.push({\r\n        fullName,\r\n        groupName,\r\n        id: id,\r\n        failure: failure,\r\n        properties: row,\r\n      });\r\n    }\r\n  }\r\n  return result;\r\n}\r\n\r\nasync function readRowsFromSpreadsheetAsync(\r\n  spreadsheetId: string,\r\n  sheetName: string\r\n) {\r\n  const sheet = googleApi.getSpreadsheet(spreadsheetId);\r\n  const rows = (await sheet.readAsync(sheetName + \"!A1:ZZ100\"))\r\n    .values as string[][];\r\n  return rows || null;\r\n}\r\n\r\nfunction getHeader(rows: string[][]) {\r\n  const header = rows && rows[0];\r\n  if (!header) throw new Error(`Лист Google-таблицы не содержит строк`);\r\n  return header;\r\n}\r\n\r\nfunction buildIndicesBy(header: string[]): Indices {\r\n  const defaultGroupColumnName = \"Группа в БРС\";\r\n  const defaultFullNameColumnName = \"Фамилия Имя в БРС\";\r\n  const defaultFailureColumnName = \"Причина отсутствия\";\r\n  const disciplineParameterKeyColumnPrefix = \"Названия параметров\";\r\n  const disciplineParameterValueColumnPrefix = \"Значения параметров\";\r\n\r\n  const normalizedHeader = header && header.map((s) => normalizeString(s));\r\n  const groupColumnIndex = normalizedHeader.indexOf(\r\n    normalizeString(defaultGroupColumnName)\r\n  );\r\n  const fullNameColumnIndex = normalizedHeader.indexOf(\r\n    normalizeString(defaultFullNameColumnName)\r\n  );\r\n  const failureColumnIndex = normalizedHeader.indexOf(\r\n    normalizeString(defaultFailureColumnName)\r\n  );\r\n  const disciplineParameterKeyColumnIndex = normalizedHeader.indexOf(\r\n    normalizeString(disciplineParameterKeyColumnPrefix)\r\n  );\r\n  const disciplineParameterValueColumnIndex = normalizedHeader.indexOf(\r\n    normalizeString(disciplineParameterValueColumnPrefix)\r\n  );\r\n\r\n  if (\r\n    failureColumnIndex < 0 ||\r\n    groupColumnIndex < 0 ||\r\n    fullNameColumnIndex < 0 ||\r\n    groupColumnIndex > failureColumnIndex ||\r\n    fullNameColumnIndex > failureColumnIndex ||\r\n    Math.abs(fullNameColumnIndex - groupColumnIndex) !== 1 ||\r\n    disciplineParameterKeyColumnIndex < 0 ||\r\n    disciplineParameterValueColumnIndex < 0 ||\r\n    disciplineParameterKeyColumnIndex <= failureColumnIndex ||\r\n    disciplineParameterValueColumnIndex <= failureColumnIndex ||\r\n    disciplineParameterValueColumnIndex !==\r\n      disciplineParameterKeyColumnIndex + 1\r\n  )\r\n    throw new Error(`Неправильный порядок столбцов`);\r\n  const leftIndex = Math.min(groupColumnIndex, fullNameColumnIndex);\r\n  const rightIndex = failureColumnIndex;\r\n\r\n  return {\r\n    groupColumn: groupColumnIndex,\r\n    fullNameColumn: fullNameColumnIndex,\r\n    failureColumn: failureColumnIndex,\r\n    disciplineKeyColumn: disciplineParameterKeyColumnIndex,\r\n    disciplineValueColumn: disciplineParameterValueColumnIndex,\r\n    left: leftIndex,\r\n    right: rightIndex,\r\n  };\r\n}\r\n\r\nfunction buildDataRange(sheetName: string, indices: Indices) {\r\n  const leftLetter = String.fromCharCode(\"A\".charCodeAt(0) + indices.left);\r\n  const rightLetter = String.fromCharCode(\"A\".charCodeAt(0) + indices.right);\r\n  return `${sheetName}!${leftLetter}2:${rightLetter}`;\r\n}\r\n\r\nfunction buildControlActionConfig(header: string[], indices: Indices) {\r\n  const controlActionConfigs: ControlActionConfig[] = [];\r\n  for (let index = indices.left; index <= indices.right; index++) {\r\n    if (\r\n      index === indices.groupColumn ||\r\n      index === indices.fullNameColumn ||\r\n      index === indices.failureColumn ||\r\n      !header[index]\r\n    ) {\r\n      continue;\r\n    }\r\n    controlActionConfigs.push({\r\n      controlActions: [header[index]],\r\n      propertyIndex: index - indices.left,\r\n    });\r\n  }\r\n\r\n  for (const config of controlActionConfigs) {\r\n    if (config.controlActions.length === 1) {\r\n      const sameColumns = controlActionConfigs.filter(\r\n        (c) =>\r\n          c.controlActions.length === 1 &&\r\n          compareNormalized(c.controlActions[0], config.controlActions[0])\r\n      );\r\n      if (sameColumns.length > 1) {\r\n        config.matchCount = sameColumns.length;\r\n        for (\r\n          let matchIndex = 0;\r\n          matchIndex < sameColumns.length;\r\n          matchIndex++\r\n        ) {\r\n          sameColumns[matchIndex].matchIndex = matchIndex;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return controlActionConfigs;\r\n}\r\n\r\nfunction buildDisciplineConfig(rows: string[][], indices: Indices) {\r\n  const result: DisciplineConfig = {\r\n    name: \"\",\r\n    year: 0,\r\n    termType: TermType.Fall,\r\n    course: 1,\r\n    isModule: false,\r\n    defaultStudentFailure: StudentFailure.NoFailure,\r\n  };\r\n\r\n  for (let i = 0; i < rows.length; i++) {\r\n    const key = rows[i][indices.disciplineKeyColumn]?.trim();\r\n    if (!key) {\r\n      break;\r\n    }\r\n    const value = rows[i][indices.disciplineValueColumn]?.trim();\r\n    addDisciplineConfigParameter(result, key, value);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction addDisciplineConfigParameter(\r\n  config: DisciplineConfig,\r\n  key: string,\r\n  value: string\r\n) {\r\n  if (compareNormalized(key, \"Дисциплина\")) {\r\n    if (value) {\r\n      config.name = value;\r\n    }\r\n  } else if (compareNormalized(key, \"ИТС\")) {\r\n    if (value) {\r\n      config.isModule = value.toLowerCase() === \"да\";\r\n    }\r\n  } else if (compareNormalized(key, \"Год\")) {\r\n    if (value) {\r\n      config.year = parseInt(value.toLowerCase(), 10);\r\n    }\r\n  } else if (compareNormalized(key, \"Учебный год\")) {\r\n    if (value) {\r\n      const yearParts = value.toLowerCase().split(\"/\");\r\n      config.year = parseInt(yearParts[0], 10);\r\n    }\r\n  } else if (compareNormalized(key, \"Семестр\")) {\r\n    if (value) {\r\n      if (value.toLowerCase() === \"осенний\") {\r\n        config.termType = TermType.Fall;\r\n      } else if (value.toLowerCase() === \"весенний\") {\r\n        config.termType = TermType.Spring;\r\n      }\r\n    }\r\n  } else if (compareNormalized(key, \"Курс\")) {\r\n    if (value) {\r\n      const lowerValue = value.toLowerCase().trim();\r\n      if (lowerValue === \"все курсы\") {\r\n        config.course = 0;\r\n      } else {\r\n        config.course = parseInt(value.toLowerCase(), 10);\r\n      }\r\n    }\r\n  } else if (compareNormalized(key, \"Причина отсутствия по умолчанию\")) {\r\n    config.defaultStudentFailure =\r\n      parseStudentFailure(value) ?? StudentFailure.NoFailure;\r\n  }\r\n}\r\n\r\ninterface Indices {\r\n  groupColumn: number;\r\n  fullNameColumn: number;\r\n  failureColumn: number;\r\n  disciplineKeyColumn: number;\r\n  disciplineValueColumn: number;\r\n  left: number;\r\n  right: number;\r\n}\r\n","import React from \"react\";\r\nimport \"./styles.css\";\r\nimport {\r\n  Collapse,\r\n  List,\r\n  ListItem,\r\n  ListItemIcon,\r\n  ListItemText,\r\n  ListSubheader,\r\n} from \"@material-ui/core\";\r\nimport { ExpandLess, ExpandMore } from \"@material-ui/icons\";\r\n\r\nexport default function NestedList(props: NestedListProps) {\r\n  const { title, items, icons } = props;\r\n\r\n  const listSubheader = (\r\n    <ListSubheader component=\"div\" id=\"nested-list-subheader\" hidden={!title}>\r\n      {title}\r\n    </ListSubheader>\r\n  );\r\n\r\n  return (\r\n    <List\r\n      component=\"nav\"\r\n      aria-labelledby=\"nested-list-subheader\"\r\n      subheader={listSubheader}\r\n      className=\"nested-list primary\"\r\n    >\r\n      {items.length ? renderNestedItems(items, 0, icons) : renderEmpty()}\r\n    </List>\r\n  );\r\n}\r\n\r\nfunction renderNestedItems(\r\n  items: NestedItem[],\r\n  level: number,\r\n  icons?: (JSX.Element | null)[]\r\n) {\r\n  return items.map((item, index) => (\r\n    <NestedListItem key={index} item={item} icons={icons} level={level} />\r\n  ));\r\n}\r\n\r\nfunction renderEmpty() {\r\n  return (\r\n    <ListItem className=\"text-align-center\">\r\n      <ListItemText primary=\"...\" />\r\n    </ListItem>\r\n  );\r\n}\r\n\r\nfunction NestedListItem({ item, level, icons }: NestedListItemProps) {\r\n  const { title, nestedItems, colored, collapsed } = item;\r\n\r\n  const [open, setOpen] = React.useState(!collapsed);\r\n\r\n  const hasSubItems = nestedItems && nestedItems.length > 0;\r\n\r\n  const color = colored && \"colored-back\";\r\n\r\n  const icon = icons && icons[level];\r\n  const IconPlace = icon && <ListItemIcon>{icon}</ListItemIcon>;\r\n\r\n  return (\r\n    <React.Fragment>\r\n      <ListItem\r\n        button\r\n        onClick={() => setOpen(!open)}\r\n        style={level ? { paddingLeft: 40 * level } : undefined}\r\n        className={\"hover \" + color}\r\n      >\r\n        {IconPlace}\r\n        <ListItemText primary={title} />\r\n        {hasSubItems && (open ? <ExpandLess /> : <ExpandMore />)}\r\n      </ListItem>\r\n      {hasSubItems && (\r\n        <Collapse in={open} unmountOnExit>\r\n          <List component=\"div\" disablePadding>\r\n            {nestedItems && renderNestedItems(nestedItems, level + 1, icons)}\r\n          </List>\r\n        </Collapse>\r\n      )}\r\n    </React.Fragment>\r\n  );\r\n}\r\n\r\nexport interface NestedItem {\r\n  title: string;\r\n  colored?: boolean;\r\n  collapsed?: boolean;\r\n  nestedItems?: NestedItem[];\r\n}\r\n\r\ninterface NestedListProps {\r\n  items: NestedItem[];\r\n  title?: string;\r\n  icons?: (JSX.Element | null)[];\r\n}\r\n\r\ninterface NestedListItemProps {\r\n  item: NestedItem;\r\n  level: number;\r\n  icons?: (JSX.Element | null)[];\r\n}\r\n","import { Button, Grid } from \"@material-ui/core\";\r\nimport React from \"react\";\r\n\r\nexport default function RunWorkerButtons({\r\n  enabled,\r\n  onRunWorkSafe,\r\n  onRunWorkUnsafe,\r\n}: Props) {\r\n  return (\r\n    <Grid container justify=\"space-around\">\r\n      <Grid item>\r\n        <Button\r\n          variant=\"contained\"\r\n          disabled={!enabled}\r\n          onClick={onRunWorkSafe}\r\n          color=\"primary\"\r\n        >\r\n          Попробовать сделать хорошо\r\n        </Button>\r\n      </Grid>\r\n      <Grid item>\r\n        <Button\r\n          variant=\"contained\"\r\n          disabled={!enabled}\r\n          onClick={onRunWorkUnsafe}\r\n          color=\"secondary\"\r\n        >\r\n          Сделать хорошо\r\n        </Button>\r\n      </Grid>\r\n    </Grid>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  enabled: boolean;\r\n  onRunWorkSafe: () => void;\r\n  onRunWorkUnsafe: () => void;\r\n}\r\n","import BrsApi, {\r\n  ControlAction,\r\n  Discipline,\r\n  StudentFailure,\r\n  StudentMark,\r\n} from \"../apis/BrsApi\";\r\nimport { compareNormalized, groupBy, parseAnyFloat } from \"../helpers/tools\";\r\nimport * as fio from \"../helpers/fio\";\r\nimport { ActualStudent, SpreadsheetData } from \"./SpreadsheetManager\";\r\nimport { formatStudentFailure } from \"../helpers/brsHelpers\";\r\nimport ReportManager from \"./ReportManager\";\r\n\r\nenum MarkUpdateStatus {\r\n  Updated,\r\n  Failed,\r\n  Skipped,\r\n}\r\n\r\nexport default class MarksManager {\r\n  private readonly brsApi: BrsApi;\r\n  private readonly save: boolean;\r\n  private cancelPending: boolean = false;\r\n\r\n  readonly reportManager: ReportManager;\r\n\r\n  constructor(brsApi: BrsApi, reportManager: ReportManager, save: boolean) {\r\n    this.brsApi = brsApi;\r\n    this.reportManager = reportManager;\r\n    this.save = save;\r\n  }\r\n\r\n  cancel() {\r\n    this.cancelPending = true;\r\n  }\r\n\r\n  async putMarksToBrsAsync(\r\n    spreadsheetData: SpreadsheetData,\r\n    disciplines: Discipline[]\r\n  ) {\r\n    const { actualStudents, disciplineConfig, controlActionConfigs } =\r\n      spreadsheetData;\r\n\r\n    try {\r\n      for (const discipline of disciplines) {\r\n        this.reportManager.newReport(discipline.group);\r\n\r\n        var isSuccessful = await this.putMarksForDisciplineAsync(\r\n          discipline,\r\n          actualStudents.filter((s) =>\r\n            compareNormalized(s.groupName, discipline.group)\r\n          ),\r\n          disciplineConfig.defaultStudentFailure,\r\n          controlActionConfigs\r\n        );\r\n\r\n        if (!isSuccessful) {\r\n          this.reportManager.cancelReport();\r\n          break;\r\n        }\r\n\r\n        this.reportManager.finishReport();\r\n\r\n        if (this.cancelPending) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      return null;\r\n    } catch (e) {\r\n      return e;\r\n    }\r\n  }\r\n\r\n  async putMarksForDisciplineAsync(\r\n    discipline: Discipline,\r\n    actualStudents: ActualStudent[],\r\n    defaultStudentFailure: StudentFailure,\r\n    controlActionConfigs: ControlActionConfig[]\r\n  ) {\r\n    if (actualStudents.length === 0) return;\r\n\r\n    const controlActions = await this.brsApi.getAllControlActionsCachedAsync(\r\n      discipline\r\n    );\r\n    if (\r\n      !this.checkControlActionsConfiguration(\r\n        controlActions,\r\n        controlActionConfigs\r\n      )\r\n    )\r\n      return false;\r\n\r\n    const brsStudents = await this.brsApi.getAllStudentMarksAsync(discipline);\r\n    const { mergedStudents, skippedActualStudents, skippedBrsStudents } =\r\n      this.mergeStudents(actualStudents, brsStudents);\r\n\r\n    this.logMergedStudents(\r\n      mergedStudents,\r\n      skippedActualStudents,\r\n      skippedBrsStudents\r\n    );\r\n\r\n    await this.putMarksForStudentsAsync(\r\n      discipline,\r\n      mergedStudents,\r\n      controlActionConfigs,\r\n      controlActions\r\n    );\r\n\r\n    await this.updateFailuresForSkippedStudentsAsync(\r\n      skippedBrsStudents,\r\n      discipline,\r\n      defaultStudentFailure\r\n    );\r\n\r\n    if (this.save) {\r\n      await this.brsApi.updateAllMarksAsync(discipline);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  checkControlActionsConfiguration(\r\n    controlActions: ControlAction[],\r\n    controlActionConfigs: ControlActionConfig[]\r\n  ) {\r\n    for (const config of controlActionConfigs) {\r\n      if (!this.getSuitableControlAction(config, controlActions)) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  async putMarksForStudentsAsync(\r\n    discipline: Discipline,\r\n    students: MergedStudent[],\r\n    controlActionConfigs: ControlActionConfig[],\r\n    controlActions: ControlAction[]\r\n  ) {\r\n    const ratingResults = await Promise.all(\r\n      students.map(async (student) => {\r\n        return await this.putMarksForStudentAsync(\r\n          discipline,\r\n          student,\r\n          controlActionConfigs,\r\n          controlActions\r\n        );\r\n      })\r\n    );\r\n\r\n    const groupedResults = Object.entries(groupBy(ratingResults, \"status\")).map(\r\n      ([groupKey, rawStudents]) => ({\r\n        title: formatMarkUpdateStatus(rawStudents[0][\"status\"]),\r\n        students: rawStudents.map((s) => s.infoString),\r\n      })\r\n    );\r\n\r\n    this.reportManager.currentReport.marks.push(...groupedResults);\r\n  }\r\n\r\n  async putMarksForStudentAsync(\r\n    discipline: Discipline,\r\n    student: MergedStudent,\r\n    controlActionConfigs: ControlActionConfig[],\r\n    controlActions: ControlAction[]\r\n  ) {\r\n    let updated = 0;\r\n    let failed = 0;\r\n\r\n    const marks = [];\r\n    for (const config of controlActionConfigs) {\r\n      const controlAction = this.getSuitableControlAction(\r\n        config,\r\n        controlActions\r\n      );\r\n      if (!controlAction) {\r\n        throw new Error(\"Подходящее контрольное мероприятие не найдено\");\r\n      }\r\n\r\n      const brsMarkString = student.brs[controlAction.uuid] as string;\r\n      const brsMark = parseAnyFloat(brsMarkString);\r\n      const actualMarkString = student.actual.properties[config.propertyIndex];\r\n      const actualMark = parseAnyFloat(actualMarkString);\r\n\r\n      const needUpdateMark =\r\n        !isNaN(actualMark) &&\r\n        !(isNaN(brsMark) ? actualMark === 0 : brsMark === actualMark);\r\n      const actualMarkOutput = !isNaN(actualMark) ? actualMark.toString() : \"-\";\r\n\r\n      if (needUpdateMark) {\r\n        marks.push(\r\n          `    ${actualMarkOutput}!`.substr(`${actualMarkOutput}`.length - 1)\r\n        );\r\n      } else {\r\n        marks.push(\r\n          `    ${actualMarkOutput} `.substr(`${actualMarkOutput}`.length - 1)\r\n        );\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        if (this.save) {\r\n          await this.brsApi.putStudentMarkAsync(\r\n            student.brs.studentUuid,\r\n            controlAction.uuidWithoutPrefix,\r\n            actualMark,\r\n            discipline.groupHistoryId,\r\n            student.brs.cardType,\r\n            student.brs.disciplineLoad\r\n          );\r\n        }\r\n        updated++;\r\n      } catch (error) {\r\n        failed++;\r\n      }\r\n    }\r\n\r\n    const brsFailureStatus =\r\n      (student.brs.failure as StudentFailure) ?? StudentFailure.NoFailure;\r\n    const actualFailure = student.actual.failure ?? StudentFailure.NoFailure;\r\n    let failureStatus: string;\r\n    if (actualFailure === brsFailureStatus) {\r\n      failureStatus = `${formatStudentFailure(actualFailure)}`;\r\n    } else {\r\n      failureStatus = `${formatStudentFailure(actualFailure)}!`;\r\n      try {\r\n        if (this.save) {\r\n          await this.brsApi.putStudentFailureAsync(\r\n            student.brs.studentUuid,\r\n            discipline,\r\n            actualFailure\r\n          );\r\n        }\r\n        updated++;\r\n      } catch (error) {\r\n        failed++;\r\n      }\r\n    }\r\n\r\n    const status =\r\n      failed > 0\r\n        ? MarkUpdateStatus.Failed\r\n        : updated > 0\r\n        ? MarkUpdateStatus.Updated\r\n        : MarkUpdateStatus.Skipped;\r\n    const studentName = student.actual.fullName.substr(0, 30);\r\n    let infoString = `${studentName}, баллы: ${marks.join(\" \")}`;\r\n    if (failureStatus && failureStatus !== \"-\")\r\n      infoString += `, ${failureStatus}`;\r\n    return { status, infoString };\r\n  }\r\n\r\n  getSuitableControlAction(\r\n    config: ControlActionConfig,\r\n    controlActions: ControlAction[]\r\n  ) {\r\n    const suitableControlActions = controlActions.filter((a) =>\r\n      config.controlActions.some((b) => compareNormalized(a.controlAction, b))\r\n    );\r\n\r\n    const errorMessages = [];\r\n\r\n    if (suitableControlActions.length === 0) {\r\n      errorMessages.push(\r\n        `Все \"${config.controlActions.join(\", \")}\" не найдены `\r\n      );\r\n      errorMessages.push(\r\n        `Найденные контрольные мероприятия: ${controlActions\r\n          .map((a) => a.controlAction)\r\n          .join(\", \")}`\r\n      );\r\n\r\n      this.reportManager.onInvalidConfiguration(errorMessages);\r\n\r\n      return null;\r\n    }\r\n\r\n    if (config.matchIndex !== undefined || config.matchCount !== undefined) {\r\n      if (\r\n        config.matchIndex === undefined ||\r\n        config.matchCount === undefined ||\r\n        suitableControlActions.length !== config.matchCount ||\r\n        config.matchIndex >= config.matchCount\r\n      ) {\r\n        errorMessages.push(\r\n          `Неверная конфигурация ${config.controlActions.join(\", \")}`\r\n        );\r\n        errorMessages.push(`Нет соответствий: ${config.matchIndex}/${config.matchCount} \r\n                                    и ${suitableControlActions.length}`);\r\n\r\n        this.reportManager.onInvalidConfiguration(errorMessages);\r\n\r\n        return null;\r\n      }\r\n      return suitableControlActions[config.matchIndex];\r\n    }\r\n\r\n    if (suitableControlActions.length > 1) {\r\n      errorMessages.push(\r\n        `Несколько контрольных мероприятий найдены для ${config.controlActions.join(\r\n          \", \"\r\n        )}`\r\n      );\r\n      errorMessages.push(\r\n        `Найденные контрольные мероприятия: ${suitableControlActions\r\n          .map((a) => a.controlAction)\r\n          .join(\", \")}`\r\n      );\r\n\r\n      this.reportManager.onInvalidConfiguration(errorMessages);\r\n\r\n      return null;\r\n    }\r\n\r\n    return suitableControlActions[0];\r\n  }\r\n\r\n  async updateFailuresForSkippedStudentsAsync(\r\n    students: StudentMark[],\r\n    discipline: Discipline,\r\n    defaultStudentFailure: StudentFailure\r\n  ) {\r\n    const ratingResults = await Promise.all(\r\n      students.map((student) =>\r\n        this.updateFailureForStudent(student, discipline, defaultStudentFailure)\r\n      )\r\n    );\r\n\r\n    if (ratingResults.length > 0) {\r\n      const groupedResults = Object.entries(groupBy(ratingResults, \"status\")).map(\r\n        ([groupKey, rawStudents]) => ({\r\n          title: formatMarkUpdateStatus(rawStudents[0][\"status\"]),\r\n          students: rawStudents.map((s) => s.infoString),\r\n        })\r\n      );\r\n\r\n      this.reportManager.currentReport.skipped.push(...groupedResults);\r\n    }\r\n  }\r\n\r\n  async updateFailureForStudent(\r\n    student: StudentMark,\r\n    discipline: Discipline,\r\n    defaultStudentFailure: StudentFailure\r\n  ) {\r\n    let status: MarkUpdateStatus;\r\n    const brsFailureStatus = student.failure\r\n      ? (student.failure as StudentFailure)\r\n      : StudentFailure.NoFailure;\r\n    const actualFailure = defaultStudentFailure;\r\n    if (actualFailure === brsFailureStatus) {\r\n      status = MarkUpdateStatus.Skipped;\r\n    } else {\r\n      try {\r\n        if (this.save) {\r\n          await this.brsApi.putStudentFailureAsync(\r\n            student.studentUuid,\r\n            discipline,\r\n            actualFailure\r\n          );\r\n        }\r\n        status = MarkUpdateStatus.Updated;\r\n      } catch (error) {\r\n        status = MarkUpdateStatus.Failed;\r\n      }\r\n    }\r\n\r\n    const studentName = student.studentFio.substr(0, 30);\r\n    const description =\r\n      status !== MarkUpdateStatus.Skipped\r\n        ? `выставлено «${formatStudentFailure(actualFailure)}», было «${formatStudentFailure(\r\n            brsFailureStatus\r\n          )}»`\r\n        : `«${formatStudentFailure(actualFailure)}»`;\r\n\r\n    const infoString = `${studentName}, ${description}`;\r\n\r\n    return { status, infoString };\r\n  }\r\n\r\n  mergeStudents(actualStudents: ActualStudent[], brsStudents: StudentMark[]) {\r\n    const activeBrsStudents = brsStudents.filter(isStudentActive);\r\n\r\n    const mergedStudents: MergedStudent[] = [];\r\n    const skippedActualStudents: ActualStudent[] = [];\r\n    for (const actualStudent of actualStudents) {\r\n      const suitableStudents = activeBrsStudents.filter((brsStudent) =>\r\n        areStudentsLike(brsStudent, actualStudent)\r\n      );\r\n      if (suitableStudents.length === 1) {\r\n        mergedStudents.push({\r\n          actual: actualStudent,\r\n          brs: suitableStudents[0],\r\n        });\r\n      } else {\r\n        skippedActualStudents.push(actualStudent);\r\n      }\r\n    }\r\n\r\n    const skippedBrsStudents: StudentMark[] = [];\r\n    for (const brsStudent of activeBrsStudents) {\r\n      if (\r\n        !mergedStudents.some(\r\n          (ms) => ms.brs.studentUuid === brsStudent.studentUuid\r\n        )\r\n      ) {\r\n        skippedBrsStudents.push(brsStudent);\r\n      }\r\n    }\r\n\r\n    return { mergedStudents, skippedActualStudents, skippedBrsStudents };\r\n  }\r\n\r\n  logMergedStudents(\r\n    mergedStudents: MergedStudent[],\r\n    skippedActualStudents: ActualStudent[],\r\n    skippedBrsStudents: StudentMark[]\r\n  ) {\r\n    const report = this.reportManager.currentReport;\r\n\r\n    report.merge.succeed = mergedStudents.length;\r\n\r\n    if (skippedActualStudents.length > 0)\r\n      report.merge.failedActual = skippedActualStudents.map(\r\n        (s) => \"- \" + s.fullName\r\n      );\r\n\r\n    if (skippedBrsStudents.length > 0) {\r\n      report.merge.failedBrs = skippedBrsStudents.map(\r\n        (s) => \"- \" + s.studentFio\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction isStudentActive(brsStudent: StudentMark) {\r\n  return (\r\n    brsStudent.studentStatus !== \"Переведен\" &&\r\n    brsStudent.studentStatus !== \"Отчислен\"\r\n  );\r\n}\r\n\r\nfunction areStudentsLike(\r\n  brsStudent: StudentMark,\r\n  actualStudent: ActualStudent\r\n) {\r\n  const brsFullName = fio.toKey(brsStudent.studentFio);\r\n  const actualFullName = fio.toKey(actualStudent.fullName);\r\n  return brsFullName.startsWith(actualFullName);\r\n}\r\n\r\nfunction formatMarkUpdateStatus(status: MarkUpdateStatus) {\r\n  switch (status) {\r\n    case MarkUpdateStatus.Updated:\r\n      return \"ОБНОВЛЕНО\";\r\n    case MarkUpdateStatus.Skipped:\r\n      return \"ПРОПУЩЕНО\";\r\n    case MarkUpdateStatus.Failed:\r\n      return \"ПРОВАЛЕНО\";\r\n    default:\r\n      throw new Error(\"Неизвестный статус обновления оценок\");\r\n  }\r\n}\r\n\r\nexport interface ControlActionConfig {\r\n  controlActions: string[];\r\n  matchIndex?: number;\r\n  matchCount?: number;\r\n  propertyIndex: number;\r\n}\r\n\r\ninterface MergedStudent {\r\n  actual: ActualStudent;\r\n  brs: StudentMark;\r\n}\r\n","export function toShow(fio: string) {\r\n  return fio.replace(\"ё\", \"е\").replace(/[ ]+/, \" \");\r\n}\r\n\r\nexport function toKey(fio: string) {\r\n  return fio.toLowerCase().replace(\"ё\", \"е\").replace(/[ ]+/, \" \").trim();\r\n}\r\n","import React, { memo } from \"react\";\r\nimport SpreadsheetManager, {\r\n  DisciplineConfig,\r\n  SpreadsheetData,\r\n} from \"../../../managers/SpreadsheetManager\";\r\nimport NestedList, { NestedItem } from \"../../shared/NestedList\";\r\nimport { Collapse, Container } from \"@material-ui/core\";\r\nimport { compareNormalized } from \"../../../helpers/tools\";\r\nimport { getSpreadsheetProperties } from \"../../../apis/GoogleApi\";\r\nimport BrsApi, { Discipline } from \"../../../apis/BrsApi\";\r\nimport \"./styles.css\";\r\nimport RunWorkerButtons from \"../RunWorkerButtons\";\r\nimport WorkerDialog, { MarksData } from \"../WorkerDialog\";\r\nimport GroupIcon from \"@material-ui/icons/Group\";\r\nimport { ViewModule } from \"@material-ui/icons\";\r\nimport GoogleTableFetchForm from \"./GoogleTableFetchForm\";\r\n\r\nenum LastAction {\r\n  None,\r\n  LoadDisciplines,\r\n  RunWork,\r\n}\r\n\r\nclass GoogleTableFetch extends React.Component<Props, State> {\r\n  marksData: MarksData = {} as any;\r\n  workerSaveMode: boolean = false;\r\n  spreadsheetId: string = \"\";\r\n  sheetId: string | null = null;\r\n\r\n  constructor(props: Props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      tableUrl: \"\",\r\n      loading: false,\r\n      showDisciplines: false,\r\n      lastAction: LastAction.None,\r\n      tableUrlError: { error: false, message: \"\" },\r\n      disciplines: [],\r\n      allDisciplinesMissed: false,\r\n      missedDisciplinesCount: 0,\r\n      showWorkerButtons: false,\r\n      runWorker: false,\r\n    };\r\n  }\r\n\r\n  loadDisciplines = async (spreadsheetId: string, sheetId: string | null) => {\r\n    this.spreadsheetId = spreadsheetId;\r\n    this.sheetId = sheetId;\r\n\r\n    this.setState({ loading: true });\r\n\r\n    const spreadsheetData = await this.getActualSpreadsheetDataAsync(\r\n      spreadsheetId,\r\n      sheetId\r\n    );\r\n    if (!spreadsheetData) {\r\n      this.setState({ loading: false });\r\n      return;\r\n    }\r\n\r\n    const disciplines = await this.getActualDisciplinesAsync(\r\n      spreadsheetData.disciplineConfig\r\n    );\r\n    if (!disciplines) {\r\n      this.setState({ loading: false });\r\n      return;\r\n    }\r\n\r\n    const disciplinesInfo = this.disciplinesToListItems(\r\n      disciplines,\r\n      spreadsheetData\r\n    );\r\n\r\n    this.marksData.spreadsheetData = spreadsheetData;\r\n    this.marksData.suitableDisciplines = disciplines;\r\n\r\n    this.setState({\r\n      loading: false,\r\n      disciplines: disciplinesInfo.disciplines,\r\n      showDisciplines: true,\r\n      lastAction: LastAction.LoadDisciplines,\r\n      allDisciplinesMissed: disciplinesInfo.allMissed,\r\n      missedDisciplinesCount: disciplinesInfo.missedCount,\r\n      showWorkerButtons: !disciplinesInfo.allMissed,\r\n    });\r\n  };\r\n\r\n  disciplinesToListItems(\r\n    availableDisciplines: Discipline[],\r\n    spreadsheetData: SpreadsheetData\r\n  ): { allMissed: boolean; missedCount: number; disciplines: NestedItem[] } {\r\n    const actualGroups = new Set(\r\n      spreadsheetData.actualStudents.map((s) => s.groupName)\r\n    );\r\n    const availableGroups = new Set(availableDisciplines.map((s) => s.group));\r\n\r\n    let missedCount = 0;\r\n    const nestedItems: NestedItem[] = Array.from(actualGroups).map((group) => {\r\n      const groupMissed = !availableGroups.has(group);\r\n      if (groupMissed) missedCount++;\r\n      return { title: group, colored: groupMissed };\r\n    });\r\n\r\n    return {\r\n      allMissed: missedCount === actualGroups.size,\r\n      missedCount,\r\n      disciplines: [\r\n        {\r\n          title: spreadsheetData.disciplineConfig.name,\r\n          nestedItems,\r\n        },\r\n      ],\r\n    };\r\n  }\r\n\r\n  async getActualDisciplinesAsync(disciplineConfig: DisciplineConfig) {\r\n    try {\r\n      const allDisciplines = await this.props.brsApi.getDisciplineCachedAsync(\r\n        disciplineConfig.year,\r\n        disciplineConfig.termType,\r\n        disciplineConfig.course,\r\n        disciplineConfig.isModule\r\n      );\r\n\r\n      return allDisciplines.filter((d) =>\r\n        compareNormalized(d.discipline, disciplineConfig.name)\r\n      );\r\n    } catch (error) {\r\n      this.props.onError(error);\r\n    }\r\n  }\r\n\r\n  async getActualSpreadsheetDataAsync(\r\n    spreadsheetId: string,\r\n    sheetId: string | null\r\n  ) {\r\n    const sheetName = await this.getSheetName(spreadsheetId, sheetId);\r\n    if (!sheetName) {\r\n      return null;\r\n    }\r\n\r\n    let spreadsheetData: SpreadsheetData;\r\n    try {\r\n      const spreadsheetManager = new SpreadsheetManager(spreadsheetId);\r\n      spreadsheetData = await spreadsheetManager.getSpreadsheetDataAsync(\r\n        sheetName\r\n      );\r\n    } catch (e) {\r\n      this.props.onError(e.message || JSON.stringify(e));\r\n      return null;\r\n    }\r\n\r\n    return spreadsheetData;\r\n  }\r\n\r\n  async getSheetName(\r\n    spreadsheetId: string,\r\n    sheetId: string | null\r\n  ): Promise<string | null> {\r\n    try {\r\n      const spreadsheetProperties = await getSpreadsheetProperties(\r\n        spreadsheetId\r\n      );\r\n      const maybeSheet = sheetId\r\n        ? spreadsheetProperties.filter(\r\n            (s) => s.sheetId.toString() === sheetId\r\n          )[0]\r\n        : spreadsheetProperties[0];\r\n      if (!maybeSheet) {\r\n        this.props.onError(\"Таблица не найдена\");\r\n        return null;\r\n      }\r\n      return maybeSheet.title;\r\n    } catch (e) {\r\n      this.props.onError(e.message || JSON.stringify(e));\r\n      return null;\r\n    }\r\n  }\r\n\r\n  updateCachedDisciplines = (\r\n    event: React.MouseEvent<HTMLButtonElement, MouseEvent>\r\n  ) => {\r\n    event.preventDefault();\r\n    this.setState({ showDisciplines: false });\r\n\r\n    const disciplineConfig = this.marksData.spreadsheetData?.disciplineConfig;\r\n    if (!disciplineConfig) return;\r\n\r\n    this.props.brsApi\r\n      .clearDisciplineCacheAsync(\r\n        disciplineConfig.year,\r\n        disciplineConfig.termType,\r\n        disciplineConfig.course,\r\n        disciplineConfig.isModule\r\n      )\r\n      .then(\r\n        (x) => x,\r\n        (error) => {\r\n          this.props.onError(error);\r\n        }\r\n      );\r\n\r\n    this.loadDisciplines(this.spreadsheetId, this.sheetId);\r\n  };\r\n\r\n  runWork = async (save: boolean) => {\r\n    if (this.state.lastAction !== LastAction.LoadDisciplines) {\r\n      await this.loadDisciplines(this.spreadsheetId, this.sheetId);\r\n    }\r\n    this.workerSaveMode = save;\r\n    this.setState({\r\n      lastAction: LastAction.RunWork,\r\n      runWorker: true\r\n    });\r\n  };\r\n\r\n  handleRunWorkSafe = () => this.runWork(false);\r\n\r\n  handleRunWorkUnsafe = () => this.runWork(true);\r\n\r\n  handleWorkerClosed = () => this.setState({ runWorker: false });\r\n\r\n  render() {\r\n    return (\r\n      <span className=\"spreadsheet-fetch\">\r\n        <h3 className=\"vertical-margin-min\">\r\n          Вставьте ссылку на лист Google Таблицы с оценками\r\n        </h3>\r\n        <GoogleTableFetchForm\r\n          loading={this.state.loading}\r\n          onSubmit={this.loadDisciplines}\r\n        />\r\n\r\n        <Collapse\r\n          in={this.state.showDisciplines}\r\n          className=\"vertical-margin-min\"\r\n        >\r\n          <h3>Загруженная дисциплина из Google Таблицы</h3>\r\n          {this.state.missedDisciplinesCount > 0 && (\r\n            <p>\r\n              Группы, к которым у вас нет доступа в БРС,{\" \"}\r\n              <b className=\"colored-text\"> подсвечены</b>\r\n            </p>\r\n          )}\r\n\r\n          <NestedList\r\n            items={this.state.disciplines}\r\n            icons={[<ViewModule />, <GroupIcon />]}\r\n          />\r\n\r\n          {this.state.allDisciplinesMissed ? (\r\n            <React.Fragment>\r\n              <p>У вас нет доступа ни к одной из перечисленных групп в БРС</p>\r\n              <span>Возможные действия:</span>\r\n              <ol className=\"no-margin\">\r\n                <li>\r\n                  Убедитесь, что название дисциплины в БРС и в Google Таблицах\r\n                  совпадает\r\n                </li>\r\n                <li>Запросите доступ на дисциплину в БРС</li>\r\n                <li>Убедитесь, что техкарта согласована в БРС</li>\r\n                <li>\r\n                  <button\r\n                    className=\"button-link\"\r\n                    onClick={this.updateCachedDisciplines}\r\n                  >\r\n                    Обновите кэш групп\r\n                  </button>\r\n                </li>\r\n              </ol>\r\n            </React.Fragment>\r\n          ) : (\r\n            <React.Fragment>\r\n              <p>\r\n                Если вам доступны не все группы, которые вам доступны в БРС, то{\" \"}\r\n                <button\r\n                  className=\"button-link\"\r\n                  onClick={this.updateCachedDisciplines}\r\n                >\r\n                  обновите кэш групп\r\n                </button>\r\n              </p>\r\n              <Container className=\"vertical-margin-medium\">\r\n                <RunWorkerButtons\r\n                  enabled={this.state.showWorkerButtons}\r\n                  onRunWorkSafe={this.handleRunWorkSafe}\r\n                  onRunWorkUnsafe={this.handleRunWorkUnsafe}\r\n                />\r\n              </Container>\r\n            </React.Fragment>\r\n          )}\r\n        </Collapse>\r\n        {this.state.runWorker && (\r\n          <WorkerDialog\r\n            marksData={this.marksData}\r\n            onClosed={this.handleWorkerClosed}\r\n            brsApi={this.props.brsApi}\r\n            onError={this.props.onError}\r\n            save={this.workerSaveMode}\r\n          />\r\n        )}\r\n      </span>\r\n    );\r\n  }\r\n}\r\n\r\nexport default memo(GoogleTableFetch);\r\n\r\ninterface Props {\r\n  brsApi: BrsApi;\r\n  onError: (errorMessage: string) => void;\r\n}\r\n\r\ninterface State {\r\n  tableUrl: string;\r\n  loading: boolean;\r\n  showDisciplines: boolean;\r\n  lastAction: LastAction;\r\n  tableUrlError: { error: boolean; message: string };\r\n  disciplines: NestedItem[];\r\n  allDisciplinesMissed: boolean;\r\n  missedDisciplinesCount: number;\r\n  showWorkerButtons: boolean;\r\n  runWorker: boolean;\r\n}\r\n","export default class ReportManager {\r\n  private _currentReport: Report | null = null;\r\n  private readonly onReportFinished: (report: Report) => void;\r\n\r\n  readonly onInvalidConfiguration: (errorMessages: string[]) => void;\r\n\r\n  constructor(\r\n    onReportFinished: (report: Report) => void,\r\n    onInvalidConfiguration: (errorMessages: string[]) => void\r\n  ) {\r\n    this.onReportFinished = onReportFinished;\r\n    this.onInvalidConfiguration = onInvalidConfiguration;\r\n  }\r\n\r\n  get currentReport() {\r\n    if (!this._currentReport)\r\n      throw new Error(\"Построение отчета еще не начато\");\r\n    return this._currentReport;\r\n  }\r\n\r\n  newReport(group: string) {\r\n    this.finishReport();\r\n    this._currentReport = {\r\n      group,\r\n      merge: { succeed: 0 },\r\n      marks: [],\r\n      skipped: [],\r\n    };\r\n  }\r\n\r\n  finishReport() {\r\n    if (this._currentReport) this.onReportFinished(this._currentReport);\r\n    this._currentReport = null;\r\n  }\r\n\r\n  cancelReport() {\r\n    this._currentReport = null;\r\n  }\r\n}\r\n\r\nexport interface Report {\r\n  group: string;\r\n  merge: {\r\n    succeed: number;\r\n    failedActual?: string[];\r\n    failedBrs?: string[];\r\n  };\r\n  marks: Section[];\r\n  skipped: Section[];\r\n}\r\n\r\nexport interface Section {\r\n  title: string;\r\n  students?: string[];\r\n}\r\n","import React from \"react\";\r\nimport \"./styles.css\";\r\nimport { withStyles } from \"@material-ui/core/styles\";\r\nimport { Dialog } from \"@material-ui/core\";\r\nimport MuiDialogTitle from \"@material-ui/core/DialogTitle\";\r\nimport MuiDialogContent from \"@material-ui/core/DialogContent\";\r\nimport MuiDialogActions from \"@material-ui/core/DialogActions\";\r\nimport SubmitWithLoading from \"../../shared/SubmitWithLoading\";\r\nimport MarksManager from \"../../../managers/MarksManager\";\r\nimport BrsApi, { Discipline } from \"../../../apis/BrsApi\";\r\nimport { SpreadsheetData } from \"../../../managers/SpreadsheetManager\";\r\nimport NestedList, { NestedItem } from \"../../shared/NestedList\";\r\nimport ReportManager, { Report } from \"../../../managers/ReportManager\";\r\nimport { pluralize } from \"../../../helpers/tools\";\r\n\r\nconst DialogContent = withStyles(() => ({\r\n  root: {\r\n    padding: 0,\r\n  },\r\n}))(MuiDialogContent);\r\n\r\nconst DialogActions = withStyles(() => ({\r\n  root: {\r\n    display: \"flex\",\r\n    justifyContent: \"space-around\",\r\n  },\r\n}))(MuiDialogActions);\r\n\r\nexport default class WorkerDialog extends React.Component<Props, State> {\r\n  marksManager: MarksManager;\r\n\r\n  constructor(props: Props) {\r\n    super(props);\r\n\r\n    const { brsApi, save } = props;\r\n    const reportManager = new ReportManager(\r\n      this.logMessage,\r\n      this.logConfigurationErrors\r\n    );\r\n    this.marksManager = new MarksManager(brsApi, reportManager, save);\r\n\r\n    this.state = {\r\n      okLoading: true,\r\n      cancelPending: false,\r\n      logItems: [],\r\n    };\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.startWork();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.marksManager.cancel();\r\n  }\r\n\r\n  logConfigurationErrors = (errorMessages: string[]) => {\r\n    const logItems = errorMessages.map((title) => ({ title, colored: true }));\r\n    this.setState({ logItems });\r\n  }\r\n\r\n  logMessage = async (report: Report) => {\r\n    const logItems = await this.reportToNestedListItems(report);\r\n    this.setState({ logItems });\r\n  };\r\n\r\n  reportToNestedListItems(report: Report): Promise<NestedItem[]> {\r\n    const logItems = this.state.logItems;\r\n    return new Promise((resolve) => {\r\n      let title = `Группа ${report.group}`;\r\n      const nestedItems: NestedItem[] = [];\r\n      const mainItem: NestedItem = { title, collapsed: true, nestedItems };\r\n\r\n      let hasErrors = false;\r\n\r\n      const merge = report.merge;\r\n      let mergeResultsTitle = `Сопоставление: ${merge.succeed} успешно`;\r\n      const failedActualCount = merge.failedActual?.length || 0;\r\n      mergeResultsTitle += `, ${failedActualCount} ${pluralize(\r\n        failedActualCount,\r\n        \"неизвестный\",\r\n        \"неизвестных\",\r\n        \"неизвестных\"\r\n      )} в таблице`;\r\n      const failedBrsCount = merge.failedBrs?.length || 0;\r\n      mergeResultsTitle += `, ${failedBrsCount} ${pluralize(\r\n        failedBrsCount,\r\n        \"неизвестный\",\r\n        \"неизвестных\",\r\n        \"неизвестных\"\r\n      )} в БРС`;\r\n\r\n      const mergeInfoItem: NestedItem = {\r\n        title: mergeResultsTitle,\r\n        collapsed: true,\r\n        nestedItems: [],\r\n      };\r\n      nestedItems.push(mergeInfoItem);\r\n\r\n      if (!!merge.failedActual) {\r\n        hasErrors = true;\r\n        title = `Не удалось сопоставить ${\r\n          merge.failedActual.length\r\n        } ${pluralize(\r\n          merge.failedActual.length,\r\n          \"студента\",\r\n          \"студентов\",\r\n          \"студентов\"\r\n        )} из Google Таблицы`;\r\n        mergeInfoItem.nestedItems?.push({\r\n          title,\r\n          colored: true,\r\n          collapsed: false,\r\n          nestedItems: merge.failedActual.map((s) => ({ title: s })),\r\n        });\r\n      }\r\n      if (!!merge.failedBrs) {\r\n        hasErrors = true;\r\n        title = `Не удалось сопоставить ${merge.failedBrs.length} ${pluralize(\r\n          merge.failedBrs.length,\r\n          \"студента\",\r\n          \"студентов\",\r\n          \"студентов\"\r\n        )} из БРС`;\r\n        mergeInfoItem.nestedItems?.push({\r\n          title,\r\n          colored: true,\r\n          collapsed: false,\r\n          nestedItems: merge.failedBrs.map((s) => ({ title: s })),\r\n        });\r\n      }\r\n\r\n      const marks = report.marks;\r\n      const marksItem: NestedItem = {\r\n        title: \"Выставление баллов\",\r\n        collapsed: true,\r\n      };\r\n      marksItem.nestedItems = marks.map(({ title, students }) => ({\r\n        title: `${title}: ${students?.length ?? 0} ${pluralize(\r\n          students?.length ?? 0,\r\n          \"студент\",\r\n          \"студента\",\r\n          \"студентов\"\r\n        )}`,\r\n        nestedItems: students?.map((s) => ({ title: s })),\r\n        collapsed: false,\r\n      }));\r\n      nestedItems.push(marksItem);\r\n\r\n      const skipped = report.skipped;\r\n      if (skipped.length > 0) {\r\n        const skippedItem: NestedItem = {\r\n          title: \"Неизвестные студенты из БРС\",\r\n          collapsed: true,\r\n        };\r\n        skippedItem.nestedItems = skipped.map(({ title, students }) => ({\r\n          title: `${title}: ${students?.length ?? 0} ${pluralize(\r\n            students?.length ?? 0,\r\n            \"студент\",\r\n            \"студента\",\r\n            \"студентов\"\r\n          )}`,\r\n          nestedItems: students?.map((s) => ({ title: s })),\r\n          collapsed: false,\r\n        }));\r\n        nestedItems.push(skippedItem);\r\n      }\r\n\r\n      if (hasErrors) {\r\n        mainItem.colored = true;\r\n      }\r\n      logItems.push(mainItem);\r\n\r\n      resolve(logItems);\r\n    });\r\n  }\r\n\r\n  startWork = async () => {\r\n    const { spreadsheetData, suitableDisciplines } = this.props.marksData;\r\n    const error = await this.marksManager.putMarksToBrsAsync(\r\n      spreadsheetData,\r\n      suitableDisciplines\r\n    );\r\n\r\n    if (error) this.props.onError(error);\r\n\r\n    this.setState({\r\n      cancelPending: false,\r\n      okLoading: false,\r\n    });\r\n  };\r\n\r\n  cancelWork = () => {\r\n    this.setState({ cancelPending: true });\r\n    this.marksManager.cancel();\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      <React.Fragment>\r\n        <Dialog open={true} maxWidth=\"md\" fullWidth className=\"worker-dialog\">\r\n          <MuiDialogTitle>Журнал действий</MuiDialogTitle>\r\n          <DialogContent dividers>\r\n            <NestedList items={this.state.logItems} />\r\n          </DialogContent>\r\n          <DialogActions>\r\n            <SubmitWithLoading\r\n              loading={this.state.okLoading}\r\n              onClick={this.props.onClosed}\r\n              title=\"ок\"\r\n            />\r\n            <SubmitWithLoading\r\n              loading={this.state.cancelPending}\r\n              disabled={!this.state.okLoading}\r\n              onClick={this.cancelWork}\r\n              title=\"отмена\"\r\n            />\r\n          </DialogActions>\r\n        </Dialog>\r\n      </React.Fragment>\r\n    );\r\n  }\r\n}\r\n\r\nexport interface MarksData {\r\n  spreadsheetData: SpreadsheetData;\r\n  suitableDisciplines: Discipline[];\r\n}\r\n\r\ninterface Props {\r\n  marksData: MarksData;\r\n  brsApi: BrsApi;\r\n  save: boolean;\r\n  onClosed: () => void;\r\n  onError: (errorMessage: string) => void;\r\n}\r\n\r\ninterface State {\r\n  okLoading: boolean;\r\n  cancelPending: boolean;\r\n  logItems: NestedItem[];\r\n}\r\n","import { TextField } from \"@material-ui/core\";\r\nimport SubmitWithLoading from \"../../shared/SubmitWithLoading\";\r\nimport React, { FormEvent, useState } from \"react\";\r\nimport { TABLE_URL_PATTERN, TABLE_TEMPLATE_URL } from \"../../../Constants\";\r\n\r\nexport default function GoogleTableFetchForm({ loading, onSubmit }: Props) {\r\n  const [tableUrl, setTableUrl] = useState(\"\");\r\n  const [urlError, setUrlError] = useState(null as null | string);\r\n\r\n  const handleUrlChanged = (event: React.ChangeEvent<{ value: string }>) => {\r\n    const target = event.target;\r\n    if (urlError) setUrlError(null);\r\n    setTableUrl(target.value);\r\n  };\r\n\r\n  const handleSubmit = (e: FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    const regExp =\r\n      /d\\/(?<spreadsheetId>[a-zA-Z0-9-_]+)\\/edit(#gid=(?<sheetId>[0-9]+))?/;\r\n    const spreadsheetInfo = tableUrl.match(regExp);\r\n\r\n    if (!spreadsheetInfo?.groups || !spreadsheetInfo.groups.spreadsheetId) {\r\n      setUrlError(\"Неверный url-адрес.\");\r\n      return null;\r\n    }\r\n\r\n    const spreadsheetId = spreadsheetInfo.groups.spreadsheetId;\r\n    const maybeSheetId = spreadsheetInfo.groups.sheetId || null;\r\n\r\n    onSubmit(spreadsheetId, maybeSheetId);\r\n  };\r\n\r\n  return (\r\n    <form onSubmit={handleSubmit} className=\"vertical-margin-min\">\r\n      <TextField\r\n        name=\"table-url\"\r\n        label={\"Ссылка вида \" + TABLE_TEMPLATE_URL}\r\n        type=\"text\"\r\n        className=\"tableUrl\"\r\n        value={tableUrl}\r\n        onChange={handleUrlChanged}\r\n        error={!!urlError}\r\n        helperText={urlError}\r\n        required\r\n      />\r\n      <SubmitWithLoading\r\n        title=\"загрузить\"\r\n        loading={loading}\r\n        className=\"submit\"\r\n      />\r\n      <a\r\n        href={TABLE_URL_PATTERN}\r\n        target=\"_blank\"\r\n        rel=\"noreferrer\"\r\n        className=\"button-link\"\r\n      >\r\n        Пример таблицы для экспорта в БРС\r\n      </a>\r\n    </form>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  loading: boolean;\r\n  onSubmit: (spreadsheetId: string, sheetId: string | null) => void;\r\n}\r\n","import React from \"react\";\r\nimport {\r\n  Button,\r\n  Dialog,\r\n  DialogActions,\r\n  DialogContent,\r\n  DialogContentText,\r\n  DialogTitle,\r\n  Slide,\r\n} from \"@material-ui/core\";\r\nimport { TransitionProps } from \"@material-ui/core/transitions\";\r\n\r\nconst Transition = React.forwardRef(function Transition(\r\n  props: TransitionProps & { children?: React.ReactElement<any, any> },\r\n  ref: React.Ref<unknown>\r\n) {\r\n  return <Slide direction=\"up\" ref={ref} {...props} />;\r\n});\r\n\r\nexport default function SessionExpiredAlert({\r\n  open,\r\n  sessionName,\r\n  onOk,\r\n}: Props) {\r\n  return (\r\n    <React.Fragment>\r\n      <Dialog\r\n        open={open}\r\n        TransitionComponent={Transition}\r\n        keepMounted\r\n        aria-labelledby=\"alert-dialog-slide-title\"\r\n        aria-describedby=\"alert-dialog-slide-description\"\r\n      >\r\n        <DialogTitle id=\"alert-dialog-slide-title\">\r\n          Необходимо авторизоваться\r\n        </DialogTitle>\r\n        <DialogContent>\r\n          <DialogContentText id=\"alert-dialog-slide-description\">\r\n            Кажется, действие сессии {sessionName} истекло.\r\n            <br />\r\n            Необходимо повторно авторизоваться.\r\n          </DialogContentText>\r\n        </DialogContent>\r\n        <DialogActions\r\n          style={{ display: \"flex\", justifyContent: \"space-around\" }}\r\n        >\r\n          <Button onClick={onOk} color=\"primary\">\r\n            Ок\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n    </React.Fragment>\r\n  );\r\n}\r\n\r\ninterface Props {\r\n  open: boolean;\r\n  sessionName: string;\r\n  onOk: () => void;\r\n}\r\n","import React from \"react\";\r\nimport \"./styles.css\";\r\nimport { CircularProgress } from \"@material-ui/core\";\r\n\r\nexport default function LoadingPane() {\r\n  return (\r\n    <div className=\"loading-pane\">\r\n      <CircularProgress size={100} className=\"progress\" />\r\n    </div>\r\n  );\r\n}\r\n","import React from \"react\";\r\nimport { Button, Container } from \"@material-ui/core\";\r\nimport GoogleTableFetch from \"../GoogleTableFetch\";\r\nimport BrsApi from \"../../../apis/BrsApi\";\r\nimport SessionExpiredAlert from \"../../shared/SessionExpiredAlert\";\r\nimport CustomAlert from \"../../shared/CustomAlert\";\r\nimport GoogleAuth from \"../../../apis/GoogleAuth\";\r\nimport BrsAuth from \"../../../apis/BrsAuth\";\r\nimport { StatusCode } from \"../../../helpers/CustomError\";\r\nimport LoadingPane from \"../LoadingPane\";\r\nimport { Redirect } from \"react-router-dom\";\r\n\r\nexport default class WorkPage extends React.Component<Props, State> {\r\n  constructor(props: Props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      showControls: false,\r\n      runWork: false,\r\n      openSessionExpiredAlert: false,\r\n      sessionName: \"\",\r\n      errorMessage: \"\",\r\n      loading: true,\r\n      redirect: false,\r\n    };\r\n  }\r\n\r\n  async componentDidMount() {\r\n    await this.props.googleAuth.ensureInitializedAsync();\r\n    await this.props.brsAuth.tryRestoreAsync();\r\n\r\n    const brsAuthorized = this.props.brsAuth.checkAuth();\r\n    const googleAuthorized = this.props.googleAuth.checkAuthorized();\r\n\r\n    if (!brsAuthorized) this.handleSessionExpired(\"БРС\");\r\n    else if (!googleAuthorized) this.handleSessionExpired(\"Google\");\r\n    else this.setState({ loading: false });\r\n  }\r\n\r\n  handleError = (error: any) => {\r\n    const errorMessage: string = error.message || JSON.stringify(error);\r\n    if (error.statusCode)\r\n      if (error.statusCode === StatusCode.BrsUnauthorized)\r\n        this.handleSessionExpired(\"БРС\");\r\n      else this.handleSessionExpired(\"Google\");\r\n    else if (error.name === \"RequestError\")\r\n      this.setState({\r\n        errorMessage: \"В данный момент сервер недоступен. Попробуйте позже.\",\r\n      });\r\n    else this.setState({ errorMessage });\r\n  };\r\n\r\n  handleSessionExpired = (sessionName: SessionName) => {\r\n    this.setState({\r\n      openSessionExpiredAlert: true,\r\n      sessionName,\r\n      loading: false,\r\n    });\r\n  };\r\n\r\n  handleSessionExpiredOk = () => {\r\n    if (this.state.sessionName === \"БРС\") {\r\n      this.props.brsAuth.logout();\r\n      this.returnToLoginPage();\r\n      this.setState({ redirect: true });\r\n    } else if (this.state.sessionName === \"Google\") {\r\n      this.returnToLoginPage();\r\n    }\r\n  };\r\n\r\n  closeError = () => {\r\n    this.setState({ errorMessage: \"\" });\r\n  };\r\n\r\n  returnToLoginPage = () => {\r\n    this.setState({ redirect: true });\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      <React.Fragment>\r\n        {this.state.loading && <LoadingPane />}\r\n        <SessionExpiredAlert\r\n          open={this.state.openSessionExpiredAlert}\r\n          sessionName={this.state.sessionName}\r\n          onOk={this.handleSessionExpiredOk}\r\n        />\r\n        {this.state.errorMessage && (\r\n          <CustomAlert\r\n            open={!!this.state.errorMessage}\r\n            message={this.state.errorMessage}\r\n            type=\"error\"\r\n            onClose={this.closeError}\r\n          />\r\n        )}\r\n        {this.state.redirect && <Redirect to=\"/\" />}\r\n        <div className=\"work-page\">\r\n          <Container maxWidth=\"md\">\r\n            <Button\r\n              variant=\"contained\"\r\n              style={{ marginTop: 10 }}\r\n              onClick={this.returnToLoginPage}\r\n            >\r\n              Вернуться на страницу входа\r\n            </Button>\r\n            <GoogleTableFetch\r\n              brsApi={this.props.brsApi}\r\n              onError={this.handleError}\r\n            />\r\n          </Container>\r\n        </div>\r\n      </React.Fragment>\r\n    );\r\n  }\r\n}\r\n\r\ntype SessionName = \"БРС\" | \"Google\";\r\n\r\ninterface State {\r\n  showControls: boolean;\r\n  openSessionExpiredAlert: boolean;\r\n  sessionName: SessionName | \"\";\r\n  errorMessage: string;\r\n  runWork: boolean;\r\n  loading: boolean;\r\n  redirect: boolean;\r\n}\r\n\r\ninterface Props {\r\n  brsAuth: BrsAuth;\r\n  brsApi: BrsApi;\r\n  googleAuth: GoogleAuth;\r\n}\r\n","import React from \"react\";\r\nimport Context from \"../../Context\";\r\nimport WorkPage from \"./WorkPage\";\r\n\r\nexport default function WorkPageContainer() {\r\n  return (\r\n    <Context.Consumer>\r\n      {(context) =>\r\n        context && (\r\n          <WorkPage\r\n            brsAuth={context.brsAuth}\r\n            brsApi={context.brsApi}\r\n            googleAuth={context.googleAuth}\r\n          />\r\n        )\r\n      }\r\n    </Context.Consumer>\r\n  );\r\n}\r\n","import React from \"react\";\r\nimport { HashRouter, Route, Switch } from \"react-router-dom\";\r\nimport BrsUrlProvider from \"./apis/BrsUrlProvider\";\r\nimport BrsAuth from \"./apis/BrsAuth\";\r\nimport GoogleAuth from \"./apis/GoogleAuth\";\r\nimport LoginPageContainer from \"./components/login/LoginPageContainer\";\r\nimport WorkPageContainer from \"./components/work/WorkPageContainer\";\r\nimport BrsApi from \"./apis/BrsApi\";\r\nimport Context from \"./Context\";\r\n\r\nconst urlProvider = new BrsUrlProvider(true);\r\nconst brsAuth = new BrsAuth(urlProvider);\r\nconst brsApi = new BrsApi(brsAuth, urlProvider);\r\nconst googleAuth = new GoogleAuth();\r\n\r\nexport default function App() {\r\n  return (\r\n    <Context.Provider value={{ brsAuth, brsApi, googleAuth }}>\r\n      <HashRouter hashType=\"noslash\">\r\n        <Switch>\r\n          <Route path=\"/work\" component={WorkPageContainer} />\r\n          <Route exact path=\"\" component={LoginPageContainer} />\r\n        </Switch>\r\n      </HashRouter>\r\n    </Context.Provider>\r\n  );\r\n}\r\n","import { ReportHandler } from \"web-vitals\";\r\n\r\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import(\"web-vitals\").then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport App from \"./App\";\r\nimport reportWebVitals from \"./reportWebVitals\";\r\n\r\nimport \"./index.css\";\r\n\r\nReactDOM.render(<App />, document.getElementById(\"root\"));\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals();\r\n"],"sourceRoot":""}